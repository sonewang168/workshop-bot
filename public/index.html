<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“ å·¥ä½œåŠç®¡ç†ç³»çµ±</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', 'Noto Sans TC', sans-serif; background: #0f0f1a; color: #e2e8f0; min-height: 100vh; }
        .app { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%); padding: 20px; border-right: 1px solid #2a2a4a; display: flex; flex-direction: column; }
        .logo { font-size: 24px; font-weight: 700; margin-bottom: 40px; background: linear-gradient(135deg, #6366f1, #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .nav-item { padding: 14px 18px; margin: 4px 0; border-radius: 12px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 12px; color: #94a3b8; }
        .nav-item:hover { background: rgba(99, 102, 241, 0.1); color: #e2e8f0; }
        .nav-item.active { background: linear-gradient(135deg, #6366f1, #a855f7); color: #fff; }
        .main { flex: 1; padding: 30px; overflow-y: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { font-size: 28px; }
        .status-badge { padding: 8px 16px; border-radius: 20px; font-size: 13px; display: flex; align-items: center; gap: 8px; }
        .status-firebase { background: rgba(249, 115, 22, 0.2); color: #f97316; }
        .status-openai { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #1e1e2e 0%, #2a2a3a 100%); padding: 24px; border-radius: 16px; border: 1px solid #3a3a4a; }
        .stat-card .icon { font-size: 32px; margin-bottom: 12px; }
        .stat-card .value { font-size: 36px; font-weight: 700; background: linear-gradient(135deg, #6366f1, #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stat-card .label { color: #64748b; margin-top: 4px; }
        .card { background: #1e1e2e; border-radius: 16px; border: 1px solid #2a2a3a; padding: 24px; margin-bottom: 20px; }
        .card h3 { margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .btn { padding: 12px 24px; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, #6366f1, #a855f7); color: #fff; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3); }
        .btn-secondary { background: #2a2a3a; color: #e2e8f0; }
        .btn-secondary:hover { background: #3a3a4a; }
        .btn-success { background: linear-gradient(135deg, #10b981, #059669); color: #fff; }
        .btn-danger { background: #ef4444; color: #fff; }
        .btn-sm { padding: 8px 16px; font-size: 13px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 14px; text-align: left; border-bottom: 1px solid #2a2a3a; }
        th { color: #64748b; font-weight: 600; }
        .badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge-green { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .badge-yellow { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .badge-gray { background: rgba(100, 116, 139, 0.2); color: #64748b; }
        .badge-red { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: #1e1e2e; border-radius: 20px; padding: 30px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .modal h2 { margin-bottom: 24px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #94a3b8; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 16px; background: #0f0f1a; border: 1px solid #3a3a4a; border-radius: 10px; color: #e2e8f0; font-size: 15px; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #6366f1; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .toast { position: fixed; bottom: 30px; right: 30px; padding: 16px 24px; border-radius: 12px; color: #fff; font-weight: 500; z-index: 2000; animation: slideIn 0.3s; }
        .toast-success { background: linear-gradient(135deg, #10b981, #059669); }
        .toast-error { background: #ef4444; }
        @keyframes slideIn { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .empty-state { text-align: center; padding: 60px 20px; color: #64748b; }
        .empty-state .icon { font-size: 64px; margin-bottom: 20px; }
        .ai-output { background: #0f0f1a; border-radius: 12px; padding: 20px; white-space: pre-wrap; line-height: 1.8; max-height: 400px; overflow-y: auto; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .style-btn { padding: 10px 20px; margin: 5px; border-radius: 20px; border: 2px solid #3a3a4a; background: transparent; color: #94a3b8; cursor: pointer; transition: all 0.2s; }
        .style-btn:hover, .style-btn.active { border-color: #6366f1; background: rgba(99, 102, 241, 0.1); color: #6366f1; }
        
        /* æ‰‹æ©Ÿç‰ˆåº•éƒ¨å°èˆª */
        .mobile-nav { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: #1a1a2e; border-top: 1px solid #2a2a4a; padding: 8px 0; z-index: 1000; }
        .mobile-nav-inner { display: flex; justify-content: space-around; align-items: center; }
        .mobile-nav-item { display: flex; flex-direction: column; align-items: center; padding: 8px 12px; color: #64748b; font-size: 10px; cursor: pointer; border-radius: 8px; transition: all 0.2s; }
        .mobile-nav-item span { font-size: 20px; margin-bottom: 4px; }
        .mobile-nav-item.active { color: #a855f7; background: rgba(168, 85, 247, 0.1); }
        
        @media (max-width: 768px) { 
          .sidebar { display: none; } 
          .form-row { grid-template-columns: 1fr; } 
          .mobile-nav { display: block; }
          .content { padding-bottom: 80px; }
          .header { flex-direction: column; gap: 10px; align-items: flex-start; }
          .header h1 { font-size: 20px; }
        }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect } = React;

// API å‘¼å«
const API = {
  async getEvents() {
    const res = await fetch('/api/events');
    return res.json();
  },
  async addEvent(data) {
    const res = await fetch('/api/events', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
    return res.json();
  },
  async updateEvent(id, data) {
    const res = await fetch(`/api/events/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
    return res.json();
  },
  async getRegistrations(eventId) {
    const url = eventId ? `/api/registrations?eventId=${eventId}` : '/api/registrations';
    const res = await fetch(url);
    return res.json();
  },
  async addRegistration(data) {
    const res = await fetch('/api/registrations', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
    return res.json();
  },
  async getStatus() {
    const res = await fetch('/api/status');
    return res.json();
  }
};

// Toast é€šçŸ¥
function Toast({ message, type, onClose }) {
  useEffect(() => { const t = setTimeout(onClose, 3000); return () => clearTimeout(t); }, []);
  return <div className={`toast toast-${type}`}>{message}</div>;
}

// å…¬é–‹å ±åè¡¨å–®
function PublicRegisterForm({ eventId, onSuccess }) {
  const [event, setEvent] = useState(null);
  const [form, setForm] = useState({ name: '', email: '', phone: '' });
  const [loading, setLoading] = useState(true);
  const [submitting, setSubmitting] = useState(false);
  const [submitted, setSubmitted] = useState(false);
  const [mode, setMode] = useState('register'); // register, check, cancelled
  const [foundReg, setFoundReg] = useState(null);

  useEffect(() => {
    API.getEvents().then(events => {
      const ev = events.find(e => e.id === eventId);
      setEvent(ev);
      setLoading(false);
    });
  }, [eventId]);

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!form.name || !form.email) { alert('è«‹å¡«å¯«å§“åå’Œ Email'); return; }
    setSubmitting(true);
    try {
      await API.addRegistration({ ...form, eventId });
      setSubmitted(true);
    } catch (err) {
      alert('å ±åå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
    setSubmitting(false);
  };

  const checkRegistration = async (e) => {
    e.preventDefault();
    if (!form.email) { alert('è«‹å¡«å¯« Email'); return; }
    setSubmitting(true);
    try {
      const res = await fetch(`/api/registrations/check?email=${encodeURIComponent(form.email)}&eventId=${eventId}`);
      const data = await res.json();
      if (data.found) {
        setFoundReg(data.registration);
      } else {
        alert('æ‰¾ä¸åˆ°æ‚¨çš„å ±åç´€éŒ„');
      }
    } catch (err) {
      alert('æŸ¥è©¢å¤±æ•—');
    }
    setSubmitting(false);
  };

  const cancelRegistration = async () => {
    if (!confirm('ç¢ºå®šè¦å–æ¶ˆå ±åå—ï¼Ÿ')) return;
    setSubmitting(true);
    try {
      await fetch(`/api/registrations/${foundReg.id}/cancel`, { method: 'POST' });
      setMode('cancelled');
    } catch (err) {
      alert('å–æ¶ˆå¤±æ•—');
    }
    setSubmitting(false);
  };

  if (loading) return <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '100vh', background: '#0f0f1a' }}><div className="loading" style={{ width: '40px', height: '40px', borderColor: '#6366f1', borderTopColor: 'transparent' }}></div></div>;

  if (!event || event.status !== 'active') {
    return (
      <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '100vh', background: '#0f0f1a' }}>
        <div className="card" style={{ maxWidth: '500px', textAlign: 'center' }}>
          <div style={{ fontSize: '64px', marginBottom: '20px' }}>ğŸ˜¢</div>
          <h2 style={{ marginBottom: '16px' }}>æ´»å‹•ä¸å­˜åœ¨æˆ–å·²çµæŸ</h2>
          <p style={{ color: '#64748b' }}>æ­¤å ±åé€£çµå·²å¤±æ•ˆ</p>
        </div>
      </div>
    );
  }

  if (mode === 'cancelled') {
    return (
      <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '100vh', background: '#0f0f1a' }}>
        <div className="card" style={{ maxWidth: '500px', textAlign: 'center' }}>
          <div style={{ fontSize: '64px', marginBottom: '20px' }}>ğŸ‘‹</div>
          <h2 style={{ marginBottom: '16px' }}>å·²å–æ¶ˆå ±å</h2>
          <p style={{ color: '#94a3b8' }}>æ‚¨çš„å ±åå·²æˆåŠŸå–æ¶ˆï¼ŒæœŸå¾…ä¸‹æ¬¡åƒèˆ‡ï¼</p>
        </div>
      </div>
    );
  }

  if (submitted) {
    return (
      <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '100vh', background: '#0f0f1a' }}>
        <div className="card" style={{ maxWidth: '500px', textAlign: 'center' }}>
          <div style={{ fontSize: '64px', marginBottom: '20px' }}>ğŸ‰</div>
          <h2 style={{ marginBottom: '16px', color: '#10b981' }}>å ±åæˆåŠŸï¼</h2>
          <p style={{ color: '#94a3b8', marginBottom: '20px' }}>æˆ‘å€‘å·²æ”¶åˆ°æ‚¨çš„å ±åï¼Œç¢ºèªä¿¡å·²å¯„é€è‡³æ‚¨çš„ Emailã€‚</p>
          <div style={{ background: '#1a1a2e', borderRadius: '12px', padding: '20px', textAlign: 'left' }}>
            <p><strong>æ´»å‹•ï¼š</strong>{event.title}</p>
            <p><strong>æ™‚é–“ï¼š</strong>{event.date} {event.time}{event.endTime ? ' - ' + event.endTime : ''}</p>
            <p><strong>åœ°é»ï¼š</strong>{event.location}</p>
          </div>
        </div>
      </div>
    );
  }

  const spotsLeft = event.maxParticipants - (event.registrations || 0);

  return (
    <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '100vh', background: '#0f0f1a', padding: '20px' }}>
      <div style={{ maxWidth: '500px', width: '100%' }}>
        <div className="card" style={{ marginBottom: '20px', background: 'linear-gradient(135deg, #6366f1, #a855f7)', border: 'none' }}>
          <h1 style={{ fontSize: '24px', marginBottom: '16px' }}>ğŸ“ æ´»å‹•å ±å</h1>
          <h2 style={{ fontSize: '20px', marginBottom: '12px' }}>{event.title}</h2>
          <p style={{ opacity: 0.9, marginBottom: '8px' }}>ğŸ“… {event.date} {event.time}{event.endTime ? ' - ' + event.endTime : ''}</p>
          <p style={{ opacity: 0.9, marginBottom: '8px' }}>ğŸ“ {event.location}</p>
          <p style={{ opacity: 0.9 }}>ğŸ‘¥ å‰©é¤˜åé¡ï¼š{spotsLeft > 0 ? spotsLeft : 'å·²é¡æ»¿'} / {event.maxParticipants}</p>
        </div>
        
        {/* åˆ‡æ›å ±å/æŸ¥è©¢ */}
        <div style={{ display: 'flex', marginBottom: '20px', gap: '10px' }}>
          <button className={`btn ${mode === 'register' ? 'btn-primary' : 'btn-secondary'}`} style={{ flex: 1 }} onClick={() => { setMode('register'); setFoundReg(null); }}>ğŸ“ æˆ‘è¦å ±å</button>
          <button className={`btn ${mode === 'check' ? 'btn-primary' : 'btn-secondary'}`} style={{ flex: 1 }} onClick={() => { setMode('check'); setFoundReg(null); }}>ğŸ” æŸ¥è©¢/å–æ¶ˆ</button>
        </div>

        {mode === 'register' && (
          spotsLeft <= 0 ? (
            <div className="card" style={{ textAlign: 'center' }}>
              <div style={{ fontSize: '48px', marginBottom: '16px' }}>ğŸ˜¢</div>
              <p>å¾ˆæŠ±æ­‰ï¼Œæ­¤æ´»å‹•å·²é¡æ»¿</p>
            </div>
          ) : (
            <div className="card">
              <h3 style={{ marginBottom: '20px' }}>å¡«å¯«å ±åè³‡æ–™</h3>
              <form onSubmit={handleSubmit}>
                <div className="form-group">
                  <label>å§“å *</label>
                  <input value={form.name} onChange={e => setForm({...form, name: e.target.value})} placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å" required />
                </div>
                <div className="form-group">
                  <label>Email *</label>
                  <input type="email" value={form.email} onChange={e => setForm({...form, email: e.target.value})} placeholder="example@mail.com" required />
                </div>
                <div className="form-group">
                  <label>æ‰‹æ©Ÿè™Ÿç¢¼</label>
                  <input value={form.phone} onChange={e => setForm({...form, phone: e.target.value})} placeholder="0912345678" />
                </div>
                <button type="submit" className="btn btn-primary" style={{ width: '100%', justifyContent: 'center' }} disabled={submitting}>
                  {submitting ? <><span className="loading"></span> é€å‡ºä¸­...</> : 'âœ… ç¢ºèªå ±å'}
                </button>
              </form>
            </div>
          )
        )}

        {mode === 'check' && !foundReg && (
          <div className="card">
            <h3 style={{ marginBottom: '20px' }}>æŸ¥è©¢å ±åç‹€æ…‹</h3>
            <form onSubmit={checkRegistration}>
              <div className="form-group">
                <label>å ±åæ™‚çš„ Email *</label>
                <input type="email" value={form.email} onChange={e => setForm({...form, email: e.target.value})} placeholder="example@mail.com" required />
              </div>
              <button type="submit" className="btn btn-primary" style={{ width: '100%', justifyContent: 'center' }} disabled={submitting}>
                {submitting ? <><span className="loading"></span> æŸ¥è©¢ä¸­...</> : 'ğŸ” æŸ¥è©¢å ±å'}
              </button>
            </form>
          </div>
        )}

        {mode === 'check' && foundReg && (
          <div className="card">
            <h3 style={{ marginBottom: '20px' }}>æ‚¨çš„å ±åè³‡æ–™</h3>
            <div style={{ background: '#0f0f1a', padding: '16px', borderRadius: '10px', marginBottom: '20px' }}>
              <p><strong>å§“åï¼š</strong>{foundReg.name}</p>
              <p><strong>Emailï¼š</strong>{foundReg.email}</p>
              <p><strong>é›»è©±ï¼š</strong>{foundReg.phone || '-'}</p>
              <p><strong>ç‹€æ…‹ï¼š</strong><span className={`badge ${foundReg.status === 'confirmed' ? 'badge-green' : foundReg.status === 'cancelled' ? 'badge-red' : 'badge-yellow'}`}>{foundReg.status === 'confirmed' ? 'å·²ç¢ºèª' : foundReg.status === 'cancelled' ? 'å·²å–æ¶ˆ' : 'å¾…ç¢ºèª'}</span></p>
            </div>
            {foundReg.status !== 'cancelled' && (
              <button className="btn btn-danger" style={{ width: '100%', justifyContent: 'center' }} onClick={cancelRegistration} disabled={submitting}>
                {submitting ? <><span className="loading"></span> è™•ç†ä¸­...</> : 'âŒ å–æ¶ˆå ±å'}
              </button>
            )}
          </div>
        )}
        
        {event.description && (
          <div className="card">
            <h3 style={{ marginBottom: '12px' }}>ğŸ“– æ´»å‹•èªªæ˜</h3>
            <p style={{ color: '#94a3b8', lineHeight: '1.8' }}>{event.description}</p>
          </div>
        )}
      </div>
    </div>
  );
}

// å´é‚Šæ¬„
function Sidebar({ page, setPage }) {
  const items = [
    { id: 'dashboard', icon: 'ğŸ“Š', label: 'å„€è¡¨æ¿' },
    { id: 'events', icon: 'ğŸ“…', label: 'æ´»å‹•ç®¡ç†' },
    { id: 'registrations', icon: 'ğŸ“‹', label: 'å ±åç®¡ç†' },
    { id: 'notifications', icon: 'ğŸ””', label: 'é€šçŸ¥ä¸­å¿ƒ' },
    { id: 'poster', icon: 'ğŸ¨', label: 'AI æ–‡å®£' },
    { id: 'certificates', icon: 'ğŸ†', label: 'è­‰æ›¸ç”¢ç”Ÿ' },
    { id: 'showcase', icon: 'ğŸª', label: 'å­¸å“¡ä½œå“ç‰†' },
    { id: 'guide', icon: 'ğŸ“–', label: 'æ“ä½œæ‰‹å†Š' },
    { id: 'settings', icon: 'âš™ï¸', label: 'ç³»çµ±è¨­å®š' }
  ];
  return (
    <div className="sidebar">
      <div className="logo">ğŸ“ å·¥ä½œåŠç®¡ç†</div>
      {items.map(item => (
        <div key={item.id} className={`nav-item ${page === item.id ? 'active' : ''}`} onClick={() => setPage(item.id)}>
          <span>{item.icon}</span><span>{item.label}</span>
        </div>
      ))}
    </div>
  );
}

// å„€è¡¨æ¿
function Dashboard({ events, registrations, status }) {
  const active = events.filter(e => e.status === 'active').length;
  const totalRegs = registrations.length;
  const certs = events.reduce((s, e) => s + (e.certificates || 0), 0);
  
  return (
    <div>
      <div className="header">
        <h1>ğŸ“Š å„€è¡¨æ¿</h1>
        <div style={{ display: 'flex', gap: '10px' }}>
          <span className="status-badge status-firebase">ğŸ”¥ Firebase {status.firebase ? 'å·²é€£ç·š' : 'é›¢ç·š'}</span>
          <span className="status-badge status-openai">ğŸ¤– OpenAI {status.openai ? 'å·²é€£ç·š' : 'æœªè¨­å®š'}</span>
        </div>
      </div>
      <div className="stats">
        <div className="stat-card"><div className="icon">ğŸ“…</div><div className="value">{events.length}</div><div className="label">æ´»å‹•ç¸½æ•¸</div></div>
        <div className="stat-card"><div className="icon">âœ…</div><div className="value">{active}</div><div className="label">é€²è¡Œä¸­</div></div>
        <div className="stat-card"><div className="icon">ğŸ‘¥</div><div className="value">{totalRegs}</div><div className="label">å ±åäººæ•¸</div></div>
        <div className="stat-card"><div className="icon">ğŸ†</div><div className="value">{certs}</div><div className="label">å·²ç™¼è­‰æ›¸</div></div>
      </div>
      <div className="card">
        <h3>ğŸ“‹ æœ€æ–°å ±å</h3>
        {registrations.length === 0 ? (
          <div className="empty-state"><p>ç›®å‰æ²’æœ‰å ±åè³‡æ–™</p></div>
        ) : (
          <table>
            <thead><tr><th>å§“å</th><th>æ´»å‹•</th><th>ç‹€æ…‹</th></tr></thead>
            <tbody>
              {registrations.slice(0, 5).map(r => {
                const ev = events.find(e => e.id === r.eventId);
                return (
                  <tr key={r.id}>
                    <td>{r.name}</td>
                    <td>{ev?.title || 'æœªçŸ¥æ´»å‹•'}</td>
                    <td><span className={`badge ${r.status === 'confirmed' ? 'badge-green' : 'badge-yellow'}`}>{r.status === 'confirmed' ? 'å·²ç¢ºèª' : 'å¾…ç¢ºèª'}</span></td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        )}
      </div>
    </div>
  );
}

// æ´»å‹•ç®¡ç†
function EventsPage({ events, onRefresh, showToast }) {
  const [showModal, setShowModal] = useState(false);
  const [editing, setEditing] = useState(null);
  const [form, setForm] = useState({ title: '', description: '', date: '', time: '', endTime: '', location: '', maxParticipants: 30, status: 'draft' });
  const [viewMode, setViewMode] = useState('active'); // active, archived
  const [showArchiveDetail, setShowArchiveDetail] = useState(null);

  // è¨ˆç®—6å€‹æœˆå‰çš„æ—¥æœŸ
  const sixMonthsAgo = new Date();
  sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);

  // åˆ†é¡æ´»å‹•
  const activeEvents = events.filter(ev => {
    if (ev.status === 'archived') return false;
    const evDate = new Date(ev.date);
    return evDate >= sixMonthsAgo || ev.status === 'active' || ev.status === 'draft';
  });

  const archivedEvents = events.filter(ev => {
    if (ev.status === 'archived') return true;
    const evDate = new Date(ev.date);
    return evDate < sixMonthsAgo && ev.status === 'ended';
  });

  const openNew = () => {
    setEditing(null);
    setForm({ title: '', description: '', date: '', time: '', endTime: '', location: '', maxParticipants: 30, status: 'draft' });
    setShowModal(true);
  };

  const openEdit = (ev) => {
    setEditing(ev);
    setForm({
      title: ev.title || '',
      description: ev.description || '',
      date: ev.date || '',
      time: ev.time || '',
      endTime: ev.endTime || '',
      location: ev.location || '',
      maxParticipants: ev.maxParticipants || 30,
      status: ev.status || 'draft'
    });
    setShowModal(true);
  };

  const handleSubmit = async () => {
    if (!form.title || !form.date) { showToast('è«‹å¡«å¯«æ´»å‹•åç¨±å’Œæ—¥æœŸ', 'error'); return; }
    
    // é©—è­‰æ—¥æœŸå¹´ä»½ (2020-2050)
    const year = parseInt(form.date.split('-')[0]);
    if (year < 2020 || year > 2050) {
      showToast('æ—¥æœŸå¹´ä»½è«‹è¼¸å…¥ 2020-2050 ä¹‹é–“çš„è¥¿å…ƒå¹´', 'error');
      return;
    }
    
    if (editing) {
      await fetch(`/api/events/${editing.id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(form)
      });
      showToast('æ´»å‹•å·²æ›´æ–°ï¼', 'success');
    } else {
      await API.addEvent(form);
      showToast('æ´»å‹•å·²æ–°å¢ï¼', 'success');
    }
    
    setShowModal(false);
    setEditing(null);
    setForm({ title: '', description: '', date: '', time: '', endTime: '', location: '', maxParticipants: 30, status: 'draft' });
    onRefresh();
  };

  const archiveEvent = async (ev) => {
    if (!confirm(`ç¢ºå®šè¦å°å­˜ã€Œ${ev.title}ã€ï¼Ÿ`)) return;
    await fetch(`/api/events/${ev.id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: 'archived' })
    });
    showToast('æ´»å‹•å·²å°å­˜', 'success');
    onRefresh();
  };

  const unarchiveEvent = async (ev) => {
    await fetch(`/api/events/${ev.id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: 'ended' })
    });
    showToast('æ´»å‹•å·²å–æ¶ˆå°å­˜', 'success');
    onRefresh();
  };

  const deleteEvent = async (ev) => {
    if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${ev.title}ã€ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) return;
    try {
      await fetch(`/api/events/${ev.id}`, { method: 'DELETE' });
      showToast('æ´»å‹•å·²åˆªé™¤', 'success');
      setShowArchiveDetail(null);
      onRefresh();
    } catch (e) {
      showToast('åˆªé™¤å¤±æ•—', 'error');
    }
  };

  return (
    <div>
      <div className="header">
        <h1>ğŸ“… æ´»å‹•ç®¡ç†</h1>
        <div style={{ display: 'flex', gap: '10px' }}>
          <button className="btn btn-primary" onClick={openNew}>ï¼‹ æ–°å¢æ´»å‹•</button>
        </div>
      </div>

      {/* åˆ‡æ›æ¨™ç±¤ */}
      <div style={{ display: 'flex', gap: '10px', marginBottom: '20px' }}>
        <button 
          className={`style-btn ${viewMode === 'active' ? 'active' : ''}`} 
          onClick={() => setViewMode('active')}
          style={{ flex: 1, padding: '15px' }}
        >
          ğŸ“… é€²è¡Œä¸­ / è¿‘æœŸæ´»å‹•
          <span className="badge badge-green" style={{ marginLeft: '10px' }}>{activeEvents.length}</span>
        </button>
        <button 
          className={`style-btn ${viewMode === 'archived' ? 'active' : ''}`} 
          onClick={() => setViewMode('archived')}
          style={{ flex: 1, padding: '15px' }}
        >
          ğŸ“¦ å°å­˜å€ï¼ˆ6å€‹æœˆä»¥ä¸Šï¼‰
          <span className="badge badge-gray" style={{ marginLeft: '10px' }}>{archivedEvents.length}</span>
        </button>
      </div>

      {/* é€²è¡Œä¸­/è¿‘æœŸæ´»å‹• */}
      {viewMode === 'active' && (
        <div className="card">
          {activeEvents.length === 0 ? (
            <div className="empty-state">
              <div className="icon">ğŸ“…</div>
              <p>é‚„æ²’æœ‰ä»»ä½•æ´»å‹•</p>
              <button className="btn btn-primary" style={{ marginTop: '20px' }} onClick={openNew}>å»ºç«‹ç¬¬ä¸€å€‹æ´»å‹•</button>
            </div>
          ) : (
            <table>
              <thead><tr><th>æ´»å‹•åç¨±</th><th>æ—¥æœŸæ™‚é–“</th><th>åœ°é»</th><th>å ±å</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead>
              <tbody>
                {activeEvents.map(ev => (
                  <tr key={ev.id}>
                    <td><strong style={{ cursor: 'pointer', color: '#6366f1' }} onClick={() => openEdit(ev)}>{ev.title}</strong></td>
                    <td>{ev.date} {ev.time}{ev.endTime ? `-${ev.endTime}` : ''}</td>
                    <td>{ev.location}</td>
                    <td>{ev.registrations || 0}/{ev.maxParticipants}</td>
                    <td>
                      <span className={`badge ${ev.status === 'active' ? 'badge-green' : ev.status === 'draft' ? 'badge-gray' : 'badge-red'}`}>
                        {ev.status === 'active' ? 'é€²è¡Œä¸­' : ev.status === 'draft' ? 'è‰ç¨¿' : 'å·²çµæŸ'}
                      </span>
                    </td>
                    <td>
                      <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                        <button className="btn btn-secondary btn-sm" onClick={() => openEdit(ev)}>âœï¸ ç·¨è¼¯</button>
                        {ev.status === 'active' && <button className="btn btn-secondary btn-sm" onClick={() => { navigator.clipboard.writeText(`${window.location.origin}?register=${ev.id}`); showToast('å ±åé€£çµå·²è¤‡è£½ï¼', 'success'); }}>ğŸ”— é€£çµ</button>}
                        {ev.status === 'ended' && <button className="btn btn-secondary btn-sm" onClick={() => archiveEvent(ev)}>ğŸ“¦ å°å­˜</button>}
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          )}
        </div>
      )}

      {/* å°å­˜å€ */}
      {viewMode === 'archived' && (
        <div className="card">
          <div style={{ marginBottom: '15px', color: '#64748b', fontSize: '14px' }}>
            ğŸ“Œ å·²çµæŸè¶…é 6 å€‹æœˆçš„æ´»å‹•æœƒè‡ªå‹•æ­¸é¡åˆ°æ­¤å€åŸŸï¼Œæ‚¨ä¹Ÿå¯ä»¥æ‰‹å‹•å°å­˜æ´»å‹•
          </div>
          {archivedEvents.length === 0 ? (
            <div className="empty-state">
              <div className="icon">ğŸ“¦</div>
              <p>æ²’æœ‰å°å­˜çš„æ´»å‹•</p>
            </div>
          ) : (
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))', gap: '15px' }}>
              {archivedEvents.map(ev => (
                <div key={ev.id} style={{ background: '#0f0f1a', borderRadius: '12px', padding: '16px', border: '1px solid #2a2a4a' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '10px' }}>
                    <h4 style={{ margin: 0, color: '#a5b4fc' }}>{ev.title}</h4>
                    <span className="badge badge-gray">å°å­˜</span>
                  </div>
                  <div style={{ fontSize: '13px', color: '#64748b', marginBottom: '12px' }}>
                    <div>ğŸ“… {ev.date} {ev.time}{ev.endTime ? `-${ev.endTime}` : ''}</div>
                    <div>ğŸ“ {ev.location || 'æœªè¨­å®š'}</div>
                    <div>ğŸ‘¥ å ±åï¼š{ev.registrations || 0}/{ev.maxParticipants}</div>
                    <div>ğŸ† è­‰æ›¸ï¼š{ev.certificates || 0} å¼µ</div>
                  </div>
                  <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                    <button className="btn btn-secondary btn-sm" onClick={() => setShowArchiveDetail(ev)}>ğŸ‘ï¸ æŸ¥çœ‹è©³æƒ…</button>
                    <button className="btn btn-secondary btn-sm" onClick={() => unarchiveEvent(ev)}>â†© å–æ¶ˆå°å­˜</button>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      )}

      {/* æ–°å¢/ç·¨è¼¯ Modal */}
      {showModal && (
        <div className="modal-overlay" onClick={() => setShowModal(false)}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <h2>{editing ? 'âœï¸ ç·¨è¼¯æ´»å‹•' : 'â• æ–°å¢æ´»å‹•'}</h2>
            <div className="form-group">
              <label>æ´»å‹•åç¨± *</label>
              <input value={form.title} onChange={e => setForm({...form, title: e.target.value})} placeholder="ä¾‹ï¼šAI ç¹ªåœ–å·¥ä½œåŠ" />
            </div>
            <div className="form-group">
              <label>æ´»å‹•èªªæ˜</label>
              <textarea rows="3" value={form.description} onChange={e => setForm({...form, description: e.target.value})} placeholder="æ´»å‹•å…§å®¹æè¿°..." />
            </div>
            <div className="form-row">
              <div className="form-group">
                <label>æ—¥æœŸ *</label>
                <input type="date" value={form.date} onChange={e => setForm({...form, date: e.target.value})} min="2020-01-01" max="2050-12-31" />
              </div>
              <div className="form-group">
                <label>é–‹å§‹æ™‚é–“</label>
                <input type="time" value={form.time} onChange={e => setForm({...form, time: e.target.value})} />
              </div>
            </div>
            <div className="form-row">
              <div className="form-group">
                <label>çµæŸæ™‚é–“</label>
                <input type="time" value={form.endTime} onChange={e => setForm({...form, endTime: e.target.value})} />
              </div>
              <div className="form-group">
                <label>åœ°é»</label>
                <input value={form.location} onChange={e => setForm({...form, location: e.target.value})} placeholder="ä¾‹ï¼šç·šä¸Š Google Meet" />
              </div>
            </div>
            <div className="form-row">
              <div className="form-group">
                <label>äººæ•¸ä¸Šé™</label>
                <input type="number" value={form.maxParticipants} onChange={e => setForm({...form, maxParticipants: parseInt(e.target.value) || 30})} />
              </div>
              <div className="form-group">
                <label>ç‹€æ…‹</label>
                <select value={form.status} onChange={e => setForm({...form, status: e.target.value})}>
                  <option value="draft">è‰ç¨¿</option>
                  <option value="active">é€²è¡Œä¸­</option>
                  <option value="ended">å·²çµæŸ</option>
                  <option value="archived">å°å­˜</option>
                </select>
              </div>
            </div>
            <div style={{ display: 'flex', gap: '10px', marginTop: '20px', flexWrap: 'wrap' }}>
              <button className="btn btn-primary" onClick={handleSubmit}>{editing ? 'ğŸ’¾ å„²å­˜è®Šæ›´' : 'å„²å­˜æ´»å‹•'}</button>
              <button className="btn btn-secondary" onClick={() => setShowModal(false)}>å–æ¶ˆ</button>
              {editing && <button className="btn btn-danger" style={{ marginLeft: 'auto' }} onClick={() => { setShowModal(false); deleteEvent(editing); }}>ğŸ—‘ï¸ åˆªé™¤</button>}
            </div>
          </div>
        </div>
      )}

      {/* å°å­˜æ´»å‹•è©³æƒ… Modal */}
      {showArchiveDetail && (
        <div className="modal-overlay" onClick={() => setShowArchiveDetail(null)}>
          <div className="modal" onClick={e => e.stopPropagation()} style={{ maxWidth: '600px' }}>
            <h2>ğŸ“¦ {showArchiveDetail.title}</h2>
            <div style={{ background: '#0f0f1a', borderRadius: '12px', padding: '20px', marginBottom: '20px' }}>
              <table style={{ width: '100%' }}>
                <tbody>
                  <tr><td style={{ color: '#64748b', padding: '8px 0' }}>ğŸ“… æ´»å‹•æ—¥æœŸ</td><td>{showArchiveDetail.date}</td></tr>
                  <tr><td style={{ color: '#64748b', padding: '8px 0' }}>â° æ´»å‹•æ™‚é–“</td><td>{showArchiveDetail.time}{showArchiveDetail.endTime ? ` - ${showArchiveDetail.endTime}` : ''}</td></tr>
                  <tr><td style={{ color: '#64748b', padding: '8px 0' }}>ğŸ“ æ´»å‹•åœ°é»</td><td>{showArchiveDetail.location || 'æœªè¨­å®š'}</td></tr>
                  <tr><td style={{ color: '#64748b', padding: '8px 0' }}>ğŸ‘¥ å ±åäººæ•¸</td><td>{showArchiveDetail.registrations || 0} / {showArchiveDetail.maxParticipants}</td></tr>
                  <tr><td style={{ color: '#64748b', padding: '8px 0' }}>ğŸ“¨ é€šçŸ¥æ¬¡æ•¸</td><td>{showArchiveDetail.notifications || 0} æ¬¡</td></tr>
                  <tr><td style={{ color: '#64748b', padding: '8px 0' }}>ğŸ† è­‰æ›¸ç™¼é€</td><td>{showArchiveDetail.certificates || 0} å¼µ</td></tr>
                </tbody>
              </table>
              {showArchiveDetail.description && (
                <div style={{ marginTop: '15px', paddingTop: '15px', borderTop: '1px solid #2a2a4a' }}>
                  <div style={{ color: '#64748b', marginBottom: '8px' }}>ğŸ“ æ´»å‹•èªªæ˜</div>
                  <div style={{ color: '#94a3b8' }}>{showArchiveDetail.description}</div>
                </div>
              )}
            </div>
            <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
              <button className="btn btn-secondary" onClick={() => unarchiveEvent(showArchiveDetail)}>â†© å–æ¶ˆå°å­˜</button>
              <button className="btn btn-secondary" onClick={() => { setShowArchiveDetail(null); openEdit(showArchiveDetail); }}>âœï¸ ç·¨è¼¯</button>
              <button className="btn btn-danger" style={{ marginLeft: 'auto' }} onClick={() => deleteEvent(showArchiveDetail)}>ğŸ—‘ï¸ æ°¸ä¹…åˆªé™¤</button>
              <button className="btn btn-secondary" onClick={() => setShowArchiveDetail(null)}>é—œé–‰</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// å ±åç®¡ç†
function RegistrationsPage({ events, registrations, onRefresh, showToast }) {
  const [filterEvent, setFilterEvent] = useState('all');
  const [filterStatus, setFilterStatus] = useState('all');
  const [searchText, setSearchText] = useState('');
  const [expandedEvents, setExpandedEvents] = useState({});
  const [selectAll, setSelectAll] = useState({});
  const [selected, setSelected] = useState({});

  // åˆå§‹åŒ–å…¨éƒ¨å±•é–‹
  useEffect(() => {
    const expanded = {};
    events.forEach(ev => { expanded[ev.id] = true; });
    setExpandedEvents(expanded);
  }, [events.length]);

  const toggleExpand = (eventId) => {
    setExpandedEvents(prev => ({ ...prev, [eventId]: !prev[eventId] }));
  };

  const expandAll = () => {
    const expanded = {};
    events.forEach(ev => { expanded[ev.id] = true; });
    setExpandedEvents(expanded);
  };

  const collapseAll = () => {
    setExpandedEvents({});
  };

  const confirmReg = async (regId) => {
    try {
      await fetch(`/api/registrations/${regId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: 'confirmed' })
      });
      showToast('å·²ç¢ºèªå ±åï¼', 'success');
      onRefresh();
    } catch (e) {
      showToast('ç¢ºèªå¤±æ•—', 'error');
    }
  };

  const revokeReg = async (regId) => {
    if (!confirm('ç¢ºå®šè¦æ’¤éŠ·æ­¤å ±åï¼Ÿå°‡æ”¹å›ã€Œå¾…ç¢ºèªã€ç‹€æ…‹')) return;
    try {
      await fetch(`/api/registrations/${regId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: 'pending' })
      });
      showToast('å·²æ’¤éŠ·ç¢ºèª', 'success');
      onRefresh();
    } catch (e) {
      showToast('æ’¤éŠ·å¤±æ•—', 'error');
    }
  };

  const cancelReg = async (regId, eventId) => {
    if (!confirm('ç¢ºå®šè¦å–æ¶ˆæ­¤å ±åï¼Ÿ')) return;
    try {
      await fetch(`/api/registrations/${regId}/cancel`, { method: 'POST' });
      showToast('å·²å–æ¶ˆå ±å', 'success');
      onRefresh();
    } catch (e) {
      showToast('å–æ¶ˆå¤±æ•—', 'error');
    }
  };

  // æ‰¹æ¬¡ç¢ºèª
  const batchConfirm = async (eventId) => {
    const regs = registrations.filter(r => r.eventId === eventId && r.status === 'pending');
    if (regs.length === 0) { showToast('æ²’æœ‰å¾…ç¢ºèªçš„å ±å', 'error'); return; }
    if (!confirm(`ç¢ºå®šè¦æ‰¹æ¬¡ç¢ºèª ${regs.length} ç­†å ±åï¼Ÿ`)) return;
    for (const r of regs) {
      await fetch(`/api/registrations/${r.id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: 'confirmed' })
      });
    }
    showToast(`å·²ç¢ºèª ${regs.length} ç­†å ±åï¼`, 'success');
    onRefresh();
  };

  // åŒ¯å‡º CSV
  const exportCSV = (eventId) => {
    const ev = events.find(e => e.id === eventId);
    const regs = registrations.filter(r => r.eventId === eventId);
    if (regs.length === 0) { showToast('æ²’æœ‰å ±åè³‡æ–™', 'error'); return; }
    
    const headers = ['å§“å', 'Email', 'é›»è©±', 'ç‹€æ…‹', 'å ±åæ™‚é–“'];
    const statusMap = { confirmed: 'å·²ç¢ºèª', pending: 'å¾…ç¢ºèª', cancelled: 'å·²å–æ¶ˆ' };
    const rows = regs.map(r => [
      r.name,
      r.email,
      r.phone || '',
      statusMap[r.status] || r.status,
      r.createdAt || ''
    ]);
    
    const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${ev?.title || 'å ±åè³‡æ–™'}_${new Date().toISOString().slice(0, 10)}.csv`;
    a.click();
    showToast('CSV å·²ä¸‹è¼‰', 'success');
  };

  // è¤‡è£½ Email æ¸…å–®
  const copyEmails = (eventId, status = 'all') => {
    let regs = registrations.filter(r => r.eventId === eventId);
    if (status !== 'all') regs = regs.filter(r => r.status === status);
    const emails = regs.map(r => r.email).join(', ');
    if (!emails) { showToast('æ²’æœ‰ Email', 'error'); return; }
    navigator.clipboard.writeText(emails);
    showToast(`å·²è¤‡è£½ ${regs.length} å€‹ Email`, 'success');
  };

  // æŒ‰æ´»å‹•åˆ†çµ„
  const groupedByEvent = {};
  registrations.forEach(r => {
    if (!groupedByEvent[r.eventId]) {
      groupedByEvent[r.eventId] = [];
    }
    groupedByEvent[r.eventId].push(r);
  });

  // ç¯©é¸
  let filteredGroups = filterEvent === 'all' 
    ? groupedByEvent 
    : { [filterEvent]: groupedByEvent[filterEvent] || [] };

  // æœå°‹éæ¿¾
  if (searchText) {
    const search = searchText.toLowerCase();
    Object.keys(filteredGroups).forEach(eventId => {
      filteredGroups[eventId] = filteredGroups[eventId].filter(r => 
        r.name?.toLowerCase().includes(search) || 
        r.email?.toLowerCase().includes(search) ||
        r.phone?.includes(search)
      );
    });
  }

  // ç‹€æ…‹éæ¿¾
  if (filterStatus !== 'all') {
    Object.keys(filteredGroups).forEach(eventId => {
      filteredGroups[eventId] = filteredGroups[eventId].filter(r => r.status === filterStatus);
    });
  }

  // çµ±è¨ˆ
  const totalConfirmed = registrations.filter(r => r.status === 'confirmed').length;
  const totalPending = registrations.filter(r => r.status === 'pending').length;
  const totalCancelled = registrations.filter(r => r.status === 'cancelled').length;

  return (
    <div>
      <div className="header">
        <h1>ğŸ“‹ å ±åç®¡ç†</h1>
        <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
          <button className="btn btn-secondary btn-sm" onClick={expandAll}>ğŸ“‚ å…¨éƒ¨å±•é–‹</button>
          <button className="btn btn-secondary btn-sm" onClick={collapseAll}>ğŸ“ å…¨éƒ¨æ”¶åˆ</button>
        </div>
      </div>

      {/* çµ±è¨ˆå¡ç‰‡ */}
      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(120px, 1fr))', gap: '15px', marginBottom: '20px' }}>
        <div className="stat-card" style={{ cursor: 'pointer' }} onClick={() => setFilterStatus('all')}>
          <div className="icon">ğŸ‘¥</div>
          <div className="value">{registrations.length}</div>
          <div className="label">ç¸½å ±å</div>
        </div>
        <div className="stat-card" style={{ cursor: 'pointer', borderColor: filterStatus === 'confirmed' ? '#10b981' : '' }} onClick={() => setFilterStatus(filterStatus === 'confirmed' ? 'all' : 'confirmed')}>
          <div className="icon">âœ…</div>
          <div className="value" style={{ color: '#10b981' }}>{totalConfirmed}</div>
          <div className="label">å·²ç¢ºèª</div>
        </div>
        <div className="stat-card" style={{ cursor: 'pointer', borderColor: filterStatus === 'pending' ? '#f59e0b' : '' }} onClick={() => setFilterStatus(filterStatus === 'pending' ? 'all' : 'pending')}>
          <div className="icon">â³</div>
          <div className="value" style={{ color: '#f59e0b' }}>{totalPending}</div>
          <div className="label">å¾…ç¢ºèª</div>
        </div>
        <div className="stat-card" style={{ cursor: 'pointer', borderColor: filterStatus === 'cancelled' ? '#ef4444' : '' }} onClick={() => setFilterStatus(filterStatus === 'cancelled' ? 'all' : 'cancelled')}>
          <div className="icon">âŒ</div>
          <div className="value" style={{ color: '#ef4444' }}>{totalCancelled}</div>
          <div className="label">å·²å–æ¶ˆ</div>
        </div>
      </div>

      {/* æœå°‹èˆ‡ç¯©é¸ */}
      <div className="card" style={{ marginBottom: '20px' }}>
        <div style={{ display: 'flex', gap: '15px', flexWrap: 'wrap', alignItems: 'center' }}>
          <div style={{ flex: '1', minWidth: '200px' }}>
            <input placeholder="ğŸ” æœå°‹å§“åã€Emailã€é›»è©±..." value={searchText} onChange={e => setSearchText(e.target.value)}
              style={{ width: '100%', padding: '12px', background: '#0f0f1a', border: '1px solid #3a3a4a', borderRadius: '10px', color: '#e2e8f0' }} />
          </div>
          <select style={{ padding: '12px', background: '#0f0f1a', border: '1px solid #3a3a4a', borderRadius: '10px', color: '#e2e8f0' }}
            value={filterEvent} onChange={e => setFilterEvent(e.target.value)}>
            <option value="all">ğŸ“… å…¨éƒ¨æ´»å‹•</option>
            {events.map(ev => <option key={ev.id} value={ev.id}>{ev.title}</option>)}
          </select>
          <select style={{ padding: '12px', background: '#0f0f1a', border: '1px solid #3a3a4a', borderRadius: '10px', color: '#e2e8f0' }}
            value={filterStatus} onChange={e => setFilterStatus(e.target.value)}>
            <option value="all">ğŸ“Š å…¨éƒ¨ç‹€æ…‹</option>
            <option value="confirmed">âœ… å·²ç¢ºèª</option>
            <option value="pending">â³ å¾…ç¢ºèª</option>
            <option value="cancelled">âŒ å·²å–æ¶ˆ</option>
          </select>
        </div>
      </div>
      
      {registrations.length === 0 ? (
        <div className="card">
          <div className="empty-state"><div className="icon">ğŸ“‹</div><p>ç›®å‰æ²’æœ‰å ±åè³‡æ–™</p></div>
        </div>
      ) : (
        Object.keys(filteredGroups).map(eventId => {
          const ev = events.find(e => e.id === eventId);
          const regs = filteredGroups[eventId] || [];
          if (regs.length === 0 && filterEvent === 'all') return null;
          
          const allRegs = registrations.filter(r => r.eventId === eventId);
          const confirmed = allRegs.filter(r => r.status === 'confirmed').length;
          const pending = allRegs.filter(r => r.status === 'pending').length;
          const cancelled = allRegs.filter(r => r.status === 'cancelled').length;
          const isExpanded = expandedEvents[eventId];
          
          return (
            <div className="card" key={eventId} style={{ marginBottom: '20px' }}>
              {/* æ¨™é¡Œåˆ— - å¯é»æ“Šæ”¶æ”¾ */}
              <div 
                style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: isExpanded ? '16px' : '0', flexWrap: 'wrap', gap: '10px', cursor: 'pointer' }}
                onClick={() => toggleExpand(eventId)}
              >
                <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                  <span style={{ fontSize: '20px', transition: 'transform 0.2s', transform: isExpanded ? 'rotate(90deg)' : 'rotate(0deg)' }}>â–¶</span>
                  <h3 style={{ margin: 0 }}>ğŸ“… {ev?.title || 'æœªçŸ¥æ´»å‹•'}</h3>
                  {ev?.status === 'ended' && <span className="badge badge-gray">å·²çµæŸ</span>}
                  {ev?.status === 'draft' && <span className="badge badge-yellow">è‰ç¨¿</span>}
                </div>
                <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                  <span className="badge badge-green">âœ… {confirmed}</span>
                  <span className="badge badge-yellow">â³ {pending}</span>
                  <span className="badge badge-gray">âŒ {cancelled}</span>
                </div>
              </div>

              {/* å±•é–‹å…§å®¹ */}
              {isExpanded && (
                <>
                  {/* æ“ä½œæŒ‰éˆ• */}
                  <div style={{ display: 'flex', gap: '10px', marginBottom: '15px', flexWrap: 'wrap' }}>
                    {pending > 0 && (
                      <button className="btn btn-success btn-sm" onClick={(e) => { e.stopPropagation(); batchConfirm(eventId); }}>
                        âœ“ æ‰¹æ¬¡ç¢ºèª ({pending})
                      </button>
                    )}
                    <button className="btn btn-secondary btn-sm" onClick={(e) => { e.stopPropagation(); exportCSV(eventId); }}>
                      ğŸ“¥ åŒ¯å‡º CSV
                    </button>
                    <button className="btn btn-secondary btn-sm" onClick={(e) => { e.stopPropagation(); copyEmails(eventId, 'confirmed'); }}>
                      ğŸ“§ è¤‡è£½å·²ç¢ºèª Email
                    </button>
                    <button className="btn btn-secondary btn-sm" onClick={(e) => { e.stopPropagation(); copyEmails(eventId); }}>
                      ğŸ“§ è¤‡è£½å…¨éƒ¨ Email
                    </button>
                  </div>

                  {regs.length === 0 ? (
                    <p style={{ color: '#64748b', textAlign: 'center', padding: '20px' }}>æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å ±å</p>
                  ) : (
                    <div style={{ overflowX: 'auto' }}>
                      <table>
                        <thead><tr><th>å§“å</th><th>Email</th><th>é›»è©±</th><th>å ±åæ™‚é–“</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead>
                        <tbody>
                          {regs.map(r => (
                            <tr key={r.id}>
                              <td><strong>{r.name}</strong></td>
                              <td>{r.email}</td>
                              <td>{r.phone || '-'}</td>
                              <td style={{ fontSize: '12px', color: '#64748b' }}>{r.createdAt ? new Date(r.createdAt).toLocaleDateString('zh-TW') : '-'}</td>
                              <td><span className={`badge ${r.status === 'confirmed' ? 'badge-green' : r.status === 'cancelled' ? 'badge-red' : 'badge-yellow'}`}>{r.status === 'confirmed' ? 'å·²ç¢ºèª' : r.status === 'cancelled' ? 'å·²å–æ¶ˆ' : 'å¾…ç¢ºèª'}</span></td>
                              <td>
                                {r.status === 'pending' && (
                                  <>
                                    <button className="btn btn-success btn-sm" onClick={() => confirmReg(r.id)}>âœ“ ç¢ºèª</button>
                                    <button className="btn btn-danger btn-sm" style={{ marginLeft: '8px' }} onClick={() => cancelReg(r.id, r.eventId)}>âœ— å–æ¶ˆ</button>
                                  </>
                                )}
                                {r.status === 'confirmed' && (
                                  <>
                                    <button className="btn btn-secondary btn-sm" onClick={() => revokeReg(r.id)}>â†© æ’¤éŠ·</button>
                                    <button className="btn btn-danger btn-sm" style={{ marginLeft: '8px' }} onClick={() => cancelReg(r.id, r.eventId)}>âœ— å–æ¶ˆ</button>
                                  </>
                                )}
                                {r.status === 'cancelled' && <span style={{ color: '#64748b' }}>-</span>}
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                </>
              )}
            </div>
          );
        })
      )}
    </div>
  );
}

// AI æ–‡å®£
function PosterPage({ events, showToast }) {
  const [selectedEvent, setSelectedEvent] = useState('');
  const [style, setStyle] = useState('social');
  const [outputs, setOutputs] = useState({ openai: '', gemini: '' });
  const [loading, setLoading] = useState(false);
  const [savedPosters, setSavedPosters] = useState([]);

  // è¼‰å…¥å·²ä¿å­˜çš„æ–‡å®£
  useEffect(() => {
    fetch('/api/posters').then(r => r.json()).then(data => setSavedPosters(data || [])).catch(() => {});
  }, []);

  const styles = [
    { id: 'social', label: 'ğŸ“± ç¤¾ç¾¤è²¼æ–‡' },
    { id: 'formal', label: 'ğŸ“„ æ­£å¼å…¬å‘Š' },
    { id: 'fun', label: 'ğŸ‰ æ´»æ½‘é¢¨æ ¼' },
    { id: 'email', label: 'ğŸ“§ Email é‚€è«‹' }
  ];

  const styleLabels = { social: 'ç¤¾ç¾¤è²¼æ–‡', formal: 'æ­£å¼å…¬å‘Š', fun: 'æ´»æ½‘é¢¨æ ¼', email: 'Email é‚€è«‹' };

  const generate = async () => {
    if (!selectedEvent) { showToast('è«‹é¸æ“‡æ´»å‹•', 'error'); return; }
    const ev = events.find(e => e.id === selectedEvent);
    setLoading(true);
    setOutputs({ openai: '', gemini: '' });
    
    const stylePrompts = {
      social: 'ç¤¾ç¾¤è²¼æ–‡é¢¨æ ¼ï¼Œæ´»æ½‘æœ‰è¶£ï¼ŒåŒ…å« emoji å’Œ hashtag',
      formal: 'æ­£å¼å…¬å‘Šé¢¨æ ¼ï¼Œå°ˆæ¥­ç°¡æ½”',
      fun: 'è¶…ç´šæ´»æ½‘é¢¨æ ¼ï¼Œå¤§é‡ emojiï¼Œå¹´è¼•åŒ–èªæ°£',
      email: 'Email é‚€è«‹å‡½é¢¨æ ¼ï¼Œç¦®è²Œæ­£å¼ä½†è¦ªåˆ‡'
    };

    try {
      const res = await fetch('/api/generate-poster-dual', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ event: ev, style: stylePrompts[style] })
      });
      const data = await res.json();
      setOutputs({ openai: data.openai || '', gemini: data.gemini || '' });
      showToast('æ–‡å®£å·²ç”Ÿæˆï¼', 'success');
    } catch (e) {
      showToast('ç”Ÿæˆå¤±æ•—', 'error');
    }
    setLoading(false);
  };

  const savePoster = async (provider, content) => {
    const ev = events.find(e => e.id === selectedEvent);
    try {
      const res = await fetch('/api/posters', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          eventId: selectedEvent,
          eventTitle: ev.title,
          style: styleLabels[style],
          provider,
          content,
          createdAt: new Date().toISOString()
        })
      });
      const data = await res.json();
      setSavedPosters(prev => [data, ...prev]);
      showToast(`å·²ä¿å­˜ ${provider} æ–‡å®£`, 'success');
    } catch (e) {
      showToast('ä¿å­˜å¤±æ•—', 'error');
    }
  };

  const deletePoster = async (posterId) => {
    if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ–‡å®£ï¼Ÿ')) return;
    try {
      await fetch(`/api/posters/${posterId}`, { method: 'DELETE' });
      setSavedPosters(prev => prev.filter(p => p.id !== posterId));
      showToast('å·²åˆªé™¤', 'success');
    } catch (e) {
      showToast('åˆªé™¤å¤±æ•—', 'error');
    }
  };

  const clearOutputs = () => {
    setOutputs({ openai: '', gemini: '' });
  };

  const activeEvents = events.filter(e => e.status === 'active');

  return (
    <div>
      <div className="header"><h1>ğŸ¨ AI æ–‡å®£ç”¢ç”Ÿå™¨</h1></div>
      
      {/* ç”¢ç”Ÿå€ */}
      <div className="card">
        <h3>ğŸ“… é¸æ“‡æ´»å‹•</h3>
        {activeEvents.length === 0 ? (
          <p style={{ color: '#64748b' }}>æ²’æœ‰é€²è¡Œä¸­çš„æ´»å‹•ï¼Œè«‹å…ˆæ–°å¢æ´»å‹•ä¸¦è¨­ç‚ºã€Œé€²è¡Œä¸­ã€</p>
        ) : (
          <select style={{ width: '100%', padding: '12px', background: '#0f0f1a', border: '1px solid #3a3a4a', borderRadius: '10px', color: '#e2e8f0' }}
            value={selectedEvent} onChange={e => setSelectedEvent(e.target.value)}>
            <option value="">-- è«‹é¸æ“‡ --</option>
            {activeEvents.map(ev => <option key={ev.id} value={ev.id}>{ev.title}</option>)}
          </select>
        )}
      </div>
      
      <div className="card">
        <h3>âœ¨ é¸æ“‡é¢¨æ ¼</h3>
        <div>{styles.map(s => <button key={s.id} className={`style-btn ${style === s.id ? 'active' : ''}`} onClick={() => setStyle(s.id)}>{s.label}</button>)}</div>
      </div>
      
      <div className="card">
        <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
          <button className="btn btn-primary" onClick={generate} disabled={loading || !selectedEvent}>
            {loading ? <><span className="loading"></span> ç”Ÿæˆä¸­...</> : 'ğŸš€ åŒæ™‚ç”¢ç”Ÿå…©ç‰ˆæ–‡å®£'}
          </button>
          {(outputs.openai || outputs.gemini) && (
            <button className="btn btn-secondary" onClick={clearOutputs}>ğŸ—‘ï¸ æ¸…é™¤çµæœ</button>
          )}
        </div>
      </div>

      {/* é›™æ¬„é¡¯ç¤ºçµæœ */}
      {(outputs.openai || outputs.gemini) && (
        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '20px' }}>
          {/* OpenAI çµæœ */}
          <div className="card">
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
              <h3 style={{ margin: 0 }}>ğŸ¤– OpenAI GPT-4o</h3>
              {outputs.openai && (
                <button className="btn btn-success btn-sm" onClick={() => savePoster('OpenAI', outputs.openai)}>âœ“ æŒ‘é¸ä¿å­˜</button>
              )}
            </div>
            {outputs.openai ? (
              <>
                <div className="ai-output">{outputs.openai}</div>
                <button className="btn btn-secondary btn-sm" style={{ marginTop: '10px' }} onClick={() => { navigator.clipboard.writeText(outputs.openai); showToast('å·²è¤‡è£½', 'success'); }}>ğŸ“‹ è¤‡è£½</button>
              </>
            ) : (
              <p style={{ color: '#64748b' }}>æœªè¨­å®šæˆ–ç”Ÿæˆå¤±æ•—</p>
            )}
          </div>
          
          {/* Gemini çµæœ */}
          <div className="card">
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
              <h3 style={{ margin: 0 }}>âœ¨ Gemini</h3>
              {outputs.gemini && (
                <button className="btn btn-success btn-sm" onClick={() => savePoster('Gemini', outputs.gemini)}>âœ“ æŒ‘é¸ä¿å­˜</button>
              )}
            </div>
            {outputs.gemini ? (
              <>
                <div className="ai-output">{outputs.gemini}</div>
                <button className="btn btn-secondary btn-sm" style={{ marginTop: '10px' }} onClick={() => { navigator.clipboard.writeText(outputs.gemini); showToast('å·²è¤‡è£½', 'success'); }}>ğŸ“‹ è¤‡è£½</button>
              </>
            ) : (
              <p style={{ color: '#64748b' }}>æœªè¨­å®šæˆ–ç”Ÿæˆå¤±æ•—</p>
            )}
          </div>
        </div>
      )}

      {/* å·²ä¿å­˜çš„æ–‡å®£ */}
      {savedPosters.length > 0 && (
        <div className="card" style={{ marginTop: '20px' }}>
          <h3>ğŸ“ å·²ä¿å­˜çš„æ–‡å®£ï¼ˆ{savedPosters.length}ï¼‰</h3>
          {savedPosters.map(p => {
            const ev = events.find(e => e.id === p.eventId);
            const isEnded = ev?.status === 'ended';
            return (
              <div key={p.id} style={{ background: '#0f0f1a', borderRadius: '12px', padding: '16px', marginTop: '12px' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '10px', flexWrap: 'wrap', gap: '10px' }}>
                  <div>
                    <strong style={{ color: '#a5b4fc' }}>{p.eventTitle}</strong>
                    <span style={{ marginLeft: '10px', fontSize: '12px', color: '#64748b' }}>{p.style} Â· {p.provider}</span>
                    {isEnded && <span className="badge badge-red" style={{ marginLeft: '10px' }}>å·²çµæŸ</span>}
                  </div>
                  <div style={{ display: 'flex', gap: '8px' }}>
                    <button className="btn btn-secondary btn-sm" onClick={() => { navigator.clipboard.writeText(p.content); showToast('å·²è¤‡è£½', 'success'); }}>ğŸ“‹ è¤‡è£½</button>
                    <button className="btn btn-danger btn-sm" onClick={() => deletePoster(p.id)}>ğŸ—‘ï¸ åˆªé™¤</button>
                  </div>
                </div>
                <div style={{ fontSize: '14px', color: '#94a3b8', whiteSpace: 'pre-wrap', maxHeight: '150px', overflow: 'auto' }}>{p.content}</div>
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}

// è­‰æ›¸ç”¢ç”Ÿ
function CertificatesPage({ events, registrations, showToast }) {
  const [selectedEvent, setSelectedEvent] = useState('');
  const [previewReg, setPreviewReg] = useState(null);

  const formatDate = (dateStr) => {
    if (!dateStr) return '';
    const d = new Date(dateStr);
    return d.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  };

  const generateCert = (reg, ev) => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'landscape' });
    
    // èƒŒæ™¯
    doc.setFillColor(99, 102, 241);
    doc.rect(0, 0, 297, 210, 'F');
    doc.setFillColor(255, 255, 255);
    doc.roundedRect(20, 20, 257, 170, 10, 10, 'F');
    
    // æ¨™é¡Œ
    doc.setTextColor(99, 102, 241);
    doc.setFontSize(36);
    doc.text('Certificate of Completion', 148.5, 55, { align: 'center' });
    
    // åˆ†éš”ç·š
    doc.setDrawColor(99, 102, 241);
    doc.setLineWidth(0.5);
    doc.line(80, 65, 217, 65);
    
    // This is to certify that
    doc.setTextColor(100, 100, 100);
    doc.setFontSize(14);
    doc.text('This is to certify that', 148.5, 85, { align: 'center' });
    
    // å§“å
    doc.setTextColor(50, 50, 50);
    doc.setFontSize(28);
    doc.text(reg.name, 148.5, 105, { align: 'center' });
    
    // has successfully completed
    doc.setTextColor(100, 100, 100);
    doc.setFontSize(14);
    doc.text('has successfully completed the workshop', 148.5, 122, { align: 'center' });
    
    // æ´»å‹•åç¨± (ç”¨è‹±æ–‡æˆ–ä¿æŒç°¡çŸ­)
    doc.setTextColor(99, 102, 241);
    doc.setFontSize(20);
    const titleLines = doc.splitTextToSize(ev.title, 200);
    doc.text(titleLines, 148.5, 140, { align: 'center' });
    
    // æ—¥æœŸ
    doc.setTextColor(100, 100, 100);
    doc.setFontSize(12);
    doc.text(`Date: ${formatDate(ev.date)}`, 148.5, 165, { align: 'center' });
    
    doc.save(`certificate-${reg.name}.pdf`);
    showToast(`Certificate downloaded for ${reg.name}`, 'success');
  };

  const sendCertByEmail = async (reg, ev) => {
    try {
      const res = await fetch('/api/send-certificate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ registration: reg, event: ev })
      });
      const data = await res.json();
      if (data.success) {
        showToast(`è­‰æ›¸å·²å¯„é€è‡³ ${reg.email}`, 'success');
      } else {
        showToast(data.error || 'å¯„é€å¤±æ•—', 'error');
      }
    } catch (e) {
      showToast('å¯„é€å¤±æ•—', 'error');
    }
  };

  const endedEvents = events.filter(e => e.status === 'ended');
  const eventRegs = selectedEvent ? registrations.filter(r => r.eventId === selectedEvent && r.status === 'confirmed') : [];
  const selectedEventData = events.find(e => e.id === selectedEvent);

  return (
    <div>
      <div className="header"><h1>ğŸ† è­‰æ›¸ç”¢ç”Ÿ</h1></div>
      <div className="card">
        <h3>ğŸ“… é¸æ“‡å·²çµæŸçš„æ´»å‹•</h3>
        {endedEvents.length === 0 ? (
          <p style={{ color: '#64748b' }}>æ²’æœ‰å·²çµæŸçš„æ´»å‹•ã€‚è«‹å…ˆåœ¨ã€Œæ´»å‹•ç®¡ç†ã€å°‡æ´»å‹•ç‹€æ…‹æ”¹ç‚ºã€Œå·²çµæŸã€ã€‚</p>
        ) : (
          <select style={{ width: '100%', padding: '12px', background: '#0f0f1a', border: '1px solid #3a3a4a', borderRadius: '10px', color: '#e2e8f0' }}
            value={selectedEvent} onChange={e => setSelectedEvent(e.target.value)}>
            <option value="">-- è«‹é¸æ“‡ --</option>
            {endedEvents.map(ev => <option key={ev.id} value={ev.id}>{ev.title} ({ev.date})</option>)}
          </select>
        )}
      </div>
      {selectedEvent && (
        <div className="card">
          <h3>ğŸ‘¥ å·²ç¢ºèªçš„å­¸å“¡ï¼ˆ{eventRegs.length} äººï¼‰</h3>
          {eventRegs.length === 0 ? (
            <p style={{ color: '#64748b' }}>æ­¤æ´»å‹•æ²’æœ‰å·²ç¢ºèªçš„å­¸å“¡</p>
          ) : (
            <>
              <table>
                <thead><tr><th>å§“å</th><th>Email</th><th>æ“ä½œ</th></tr></thead>
                <tbody>
                  {eventRegs.map(r => (
                    <tr key={r.id}>
                      <td>{r.name}</td>
                      <td>{r.email}</td>
                      <td>
                        <button className="btn btn-primary btn-sm" onClick={() => generateCert(r, selectedEventData)}>ğŸ“„ ä¸‹è¼‰</button>
                        <button className="btn btn-secondary btn-sm" style={{ marginLeft: '8px' }} onClick={() => sendCertByEmail(r, selectedEventData)}>ğŸ“§ å¯„é€</button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
              <div style={{ marginTop: '20px', display: 'flex', gap: '10px' }}>
                <button className="btn btn-primary" onClick={() => eventRegs.forEach(r => generateCert(r, selectedEventData))}>ğŸ“„ ä¸‹è¼‰å…¨éƒ¨è­‰æ›¸</button>
                <button className="btn btn-secondary" onClick={async () => {
                  for (const r of eventRegs) { await sendCertByEmail(r, selectedEventData); }
                }}>ğŸ“§ å¯„é€å…¨éƒ¨è­‰æ›¸</button>
              </div>
            </>
          )}
        </div>
      )}
    </div>
  );
}

// ç³»çµ±è¨­å®š
function SettingsPage({ status }) {
  return (
    <div>
      <div className="header"><h1>âš™ï¸ ç³»çµ±è¨­å®š</h1></div>
      <div className="card">
        <h3>ğŸ”Œ é€£ç·šç‹€æ…‹</h3>
        <table>
          <tbody>
            <tr><td>ğŸ”¥ Firebase</td><td><span className={`badge ${status.firebase ? 'badge-green' : 'badge-red'}`}>{status.firebase ? 'å·²é€£ç·š' : 'é›¢ç·š'}</span></td></tr>
            <tr><td>ğŸ¤– OpenAI</td><td><span className={`badge ${status.openai ? 'badge-green' : 'badge-yellow'}`}>{status.openai ? 'å·²é€£ç·š' : 'æœªè¨­å®š'}</span></td></tr>
            <tr><td>âœ¨ Gemini</td><td><span className={`badge ${status.gemini ? 'badge-green' : 'badge-yellow'}`}>{status.gemini ? 'å·²é€£ç·š' : 'æœªè¨­å®š'}</span></td></tr>
            <tr><td>ğŸ“§ Email (Resend)</td><td><span className={`badge ${status.email ? 'badge-green' : 'badge-yellow'}`}>{status.email ? 'å·²é€£ç·š' : 'æœªè¨­å®š'}</span></td></tr>
            <tr><td>ğŸ‘¥ ç®¡ç†å“¡</td><td><span className={`badge ${status.adminCount > 0 ? 'badge-green' : 'badge-yellow'}`}>{status.adminCount > 0 ? status.adminCount + ' äºº' : 'æœªè¨­å®š'}</span></td></tr>
          </tbody>
        </table>
      </div>
      <div className="card">
        <h3>ğŸ“ ç’°å¢ƒè®Šæ•¸èªªæ˜</h3>
        <p style={{ color: '#94a3b8', lineHeight: '1.8' }}>
          è«‹åœ¨ Render ç’°å¢ƒè®Šæ•¸ä¸­è¨­å®šï¼š<br/><br/>
          <strong>å¿…è¦ï¼š</strong><br/>
          â€¢ <code>LINE_CHANNEL_ACCESS_TOKEN</code> - LINE Bot Token<br/>
          â€¢ <code>LINE_CHANNEL_SECRET</code> - LINE Bot Secret<br/>
          â€¢ <code>FIREBASE_SERVICE_ACCOUNT</code> - Firebase JSON<br/><br/>
          <strong>AI åŠŸèƒ½ï¼š</strong><br/>
          â€¢ <code>OPENAI_API_KEY</code> - OpenAI API é‡‘é‘°<br/>
          â€¢ <code>GEMINI_API_KEY</code> - Gemini API é‡‘é‘°<br/><br/>
          <strong>é€šçŸ¥åŠŸèƒ½ï¼š</strong><br/>
          â€¢ <code>RESEND_API_KEY</code> - Resend API é‡‘é‘°<br/>
          â€¢ <code>SENDER_EMAIL</code> - å¯„ä»¶äºº Emailï¼ˆé è¨­ onboarding@resend.devï¼‰<br/>
          â€¢ <code>ADMIN_USER_IDS</code> - ç®¡ç†å“¡ LINE User IDï¼ˆå¤šäººç”¨é€—è™Ÿåˆ†éš”ï¼‰
        </p>
      </div>
    </div>
  );
}

// é€šçŸ¥ä¸­å¿ƒ
function NotificationsPage({ events, registrations, showToast }) {
  const [sending, setSending] = useState(false);
  const [selectedEvent, setSelectedEvent] = useState('');
  const [notifyType, setNotifyType] = useState('reminder');
  const [customMessage, setCustomMessage] = useState('');
  const [schedules, setSchedules] = useState([]);
  const [showScheduleModal, setShowScheduleModal] = useState(false);
  const [scheduleForm, setScheduleForm] = useState({ type: 'reminder', daysBefore: 1, hour: 9, minute: 0, enabled: true });

  const activeEvents = events.filter(e => e.status === 'active');

  // è¼‰å…¥æ’ç¨‹
  useEffect(() => {
    fetch('/api/schedules').then(r => r.json()).then(data => setSchedules(data || [])).catch(() => {});
  }, []);

  const sendReminder = async () => {
    if (!selectedEvent) { showToast('è«‹é¸æ“‡æ´»å‹•', 'error'); return; }
    if (!customMessage.trim()) { showToast('è«‹è¼¸å…¥é€šçŸ¥å…§å®¹', 'error'); return; }
    setSending(true);
    try {
      const res = await fetch('/api/send-notification', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ eventId: selectedEvent, type: notifyType, customMessage })
      });
      const data = await res.json();
      if (data.success) {
        if (data.failed && data.failed.length > 0) {
          showToast(`å·²ç™¼é€ ${data.sent}/${data.total} å°ï¼Œ${data.failed.length} å°å¤±æ•—`, 'warning');
          console.log('ç™¼é€å¤±æ•—çš„ Email:', data.failed);
        } else {
          showToast(`å·²ç™¼é€ ${data.sent} å°é€šçŸ¥ï¼`, 'success');
        }
      } else {
        showToast(data.error || 'ç™¼é€å¤±æ•—', 'error');
      }
    } catch (e) {
      showToast('ç™¼é€å¤±æ•—', 'error');
    }
    setSending(false);
  };

  const generateAIMessage = async () => {
    if (!selectedEvent) { showToast('è«‹é¸æ“‡æ´»å‹•', 'error'); return; }
    setSending(true);
    try {
      const ev = events.find(e => e.id === selectedEvent);
      const res = await fetch('/api/generate-notification', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ event: ev, type: notifyType })
      });
      const data = await res.json();
      if (data.text) {
        setCustomMessage(data.text);
        showToast('AI å·²ç”Ÿæˆé€šçŸ¥å…§å®¹', 'success');
      }
    } catch (e) {
      showToast('ç”Ÿæˆå¤±æ•—', 'error');
    }
    setSending(false);
  };

  // æ–°å¢æ’ç¨‹
  const addSchedule = async () => {
    if (!selectedEvent) { showToast('è«‹é¸æ“‡æ´»å‹•', 'error'); return; }
    try {
      const ev = events.find(e => e.id === selectedEvent);
      const res = await fetch('/api/schedules', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          eventId: selectedEvent,
          eventTitle: ev.title,
          eventDate: ev.date,
          ...scheduleForm
        })
      });
      const data = await res.json();
      setSchedules(prev => [...prev, data]);
      setShowScheduleModal(false);
      showToast('æ’ç¨‹å·²å»ºç«‹ï¼', 'success');
    } catch (e) {
      showToast('å»ºç«‹å¤±æ•—', 'error');
    }
  };

  // åˆ‡æ›æ’ç¨‹å•Ÿç”¨
  const toggleSchedule = async (id, enabled) => {
    try {
      await fetch(`/api/schedules/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ enabled })
      });
      setSchedules(prev => prev.map(s => s.id === id ? { ...s, enabled } : s));
      showToast(enabled ? 'æ’ç¨‹å·²å•Ÿç”¨' : 'æ’ç¨‹å·²æš«åœ', 'success');
    } catch (e) {
      showToast('æ›´æ–°å¤±æ•—', 'error');
    }
  };

  // åˆªé™¤æ’ç¨‹
  const deleteSchedule = async (id) => {
    if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ’ç¨‹ï¼Ÿ')) return;
    try {
      await fetch(`/api/schedules/${id}`, { method: 'DELETE' });
      setSchedules(prev => prev.filter(s => s.id !== id));
      showToast('æ’ç¨‹å·²åˆªé™¤', 'success');
    } catch (e) {
      showToast('åˆªé™¤å¤±æ•—', 'error');
    }
  };

  // ç«‹å³åŸ·è¡Œæ’ç¨‹
  const runScheduleNow = async (schedule) => {
    setSending(true);
    try {
      const res = await fetch('/api/run-schedule', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ scheduleId: schedule.id })
      });
      const data = await res.json();
      if (data.success) {
        showToast(`å·²ç™¼é€ ${data.sent} å°é€šçŸ¥ï¼`, 'success');
      } else {
        showToast(data.error || 'ç™¼é€å¤±æ•—', 'error');
      }
    } catch (e) {
      showToast('åŸ·è¡Œå¤±æ•—', 'error');
    }
    setSending(false);
  };

  const selectedEventData = events.find(e => e.id === selectedEvent);
  const eventRegs = selectedEvent ? registrations.filter(r => r.eventId === selectedEvent && r.status === 'confirmed') : [];

  const typeLabels = {
    reminder: { icon: 'â°', label: 'ä¸Šèª²æé†’', desc: 'æ´»å‹•å‰ç™¼é€' },
    start: { icon: 'ğŸš€', label: 'æ´»å‹•é–‹å§‹', desc: 'æ´»å‹•ç•¶å¤©ç™¼é€' },
    material: { icon: 'ğŸ“š', label: 'èª²å‰è³‡æ–™', desc: 'æä¾›æº–å‚™è³‡è¨Š' },
    feedback: { icon: 'ğŸ“', label: 'èª²å¾Œå›é¥‹', desc: 'æ´»å‹•çµæŸå¾Œ' },
    custom: { icon: 'âœï¸', label: 'è‡ªè¨‚è¨Šæ¯', desc: 'è‡ªè¡Œç·¨å¯«' }
  };

  // è¨ˆç®—æ’ç¨‹ç™¼é€æ™‚é–“ï¼ˆå°ç£æ™‚é–“ï¼‰
  const getScheduleTime = (schedule) => {
    const [year, month, day] = schedule.eventDate.split('-').map(Number);
    const sendDate = new Date(year, month - 1, day);
    if (schedule.type === 'feedback') {
      sendDate.setDate(sendDate.getDate() + (schedule.daysAfter || 1));
    } else {
      sendDate.setDate(sendDate.getDate() - (schedule.daysBefore || 1));
    }
    const dateStr = `${sendDate.getFullYear()}/${sendDate.getMonth() + 1}/${sendDate.getDate()}`;
    return `${dateStr} ${String(schedule.hour || 9).padStart(2, '0')}:${String(schedule.minute || 0).padStart(2, '0')}`;
  };

  // æª¢æŸ¥æ˜¯å¦å·²éç™¼é€æ™‚é–“
  const isPastScheduleTime = (schedule) => {
    const [year, month, day] = schedule.eventDate.split('-').map(Number);
    const sendDate = new Date(year, month - 1, day);
    if (schedule.type === 'feedback') {
      sendDate.setDate(sendDate.getDate() + (schedule.daysAfter || 1));
    } else {
      sendDate.setDate(sendDate.getDate() - (schedule.daysBefore || 1));
    }
    sendDate.setHours(schedule.hour || 9, schedule.minute || 0, 0, 0);
    return new Date() >= sendDate;
  };

  return (
    <div>
      <div className="header">
        <h1>ğŸ”” é€šçŸ¥ä¸­å¿ƒ</h1>
        <button className="btn btn-primary" onClick={() => setShowScheduleModal(true)} disabled={!selectedEvent}>
          â° å»ºç«‹è‡ªå‹•æ’ç¨‹
        </button>
      </div>

      {/* è‡ªå‹•æ’ç¨‹åˆ—è¡¨ */}
      {schedules.length > 0 && (
        <div className="card" style={{ marginBottom: '20px' }}>
          <h3>â° è‡ªå‹•æ’ç¨‹åˆ—è¡¨</h3>
          <p style={{ color: '#64748b', fontSize: '14px', marginBottom: '15px' }}>
            ğŸ’¡ ç³»çµ±æœƒåœ¨æŒ‡å®šæ™‚é–“è‡ªå‹•ç™¼é€é€šçŸ¥ï¼ˆæ¯ 10 åˆ†é˜æª¢æŸ¥ä¸€æ¬¡ï¼‰
          </p>
          <div style={{ overflowX: 'auto' }}>
            <table>
              <thead>
                <tr><th>æ´»å‹•</th><th>é¡å‹</th><th>ç™¼é€æ™‚é–“</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr>
              </thead>
              <tbody>
                {schedules.map(s => {
                  const typeInfo = typeLabels[s.type] || typeLabels.custom;
                  const isPast = isPastScheduleTime(s);
                  return (
                    <tr key={s.id} style={{ opacity: s.sent ? 0.5 : 1 }}>
                      <td><strong>{s.eventTitle}</strong><br/><span style={{ fontSize: '12px', color: '#64748b' }}>{s.eventDate}</span></td>
                      <td>{typeInfo.icon} {typeInfo.label}</td>
                      <td>{getScheduleTime(s)}</td>
                      <td>
                        {s.sent ? (
                          <span className="badge badge-gray">âœ“ å·²ç™¼é€</span>
                        ) : isPast ? (
                          <span className="badge badge-yellow">â³ å¾…ç™¼é€</span>
                        ) : s.enabled ? (
                          <span className="badge badge-green">ğŸŸ¢ å•Ÿç”¨ä¸­</span>
                        ) : (
                          <span className="badge badge-gray">â¸ï¸ å·²æš«åœ</span>
                        )}
                      </td>
                      <td>
                        <div style={{ display: 'flex', gap: '5px', flexWrap: 'wrap' }}>
                          {!s.sent && (
                            <>
                              <button className="btn btn-secondary btn-sm" onClick={() => toggleSchedule(s.id, !s.enabled)}>
                                {s.enabled ? 'â¸ï¸ æš«åœ' : 'â–¶ï¸ å•Ÿç”¨'}
                              </button>
                              <button className="btn btn-primary btn-sm" onClick={() => runScheduleNow(s)} disabled={sending}>
                                ğŸš€ ç«‹å³ç™¼é€
                              </button>
                            </>
                          )}
                          <button className="btn btn-danger btn-sm" onClick={() => deleteSchedule(s.id)}>ğŸ—‘ï¸</button>
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* å¿«é€Ÿæ’ç¨‹æŒ‰éˆ• */}
      {selectedEvent && (
        <div className="card" style={{ marginBottom: '20px' }}>
          <h3>âš¡ å¿«é€Ÿå»ºç«‹æ’ç¨‹</h3>
          <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
            {[
              { type: 'reminder', daysBefore: 1, label: 'ğŸ“¢ æ´»å‹•å‰ 1 å¤©æé†’' },
              { type: 'reminder', daysBefore: 3, label: 'ğŸ“¢ æ´»å‹•å‰ 3 å¤©æé†’' },
              { type: 'start', daysBefore: 0, label: 'ğŸš€ æ´»å‹•ç•¶å¤©æé†’' },
              { type: 'feedback', daysAfter: 1, label: 'ğŸ“ æ´»å‹•å¾Œ 1 å¤©å›é¥‹' }
            ].map((preset, i) => (
              <button key={i} className="btn btn-secondary" onClick={async () => {
                const ev = events.find(e => e.id === selectedEvent);
                try {
                  const res = await fetch('/api/schedules', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                      eventId: selectedEvent,
                      eventTitle: ev.title,
                      eventDate: ev.date,
                      type: preset.type,
                      daysBefore: preset.daysBefore || 0,
                      daysAfter: preset.daysAfter || 0,
                      hour: 9,
                      minute: 0,
                      enabled: true
                    })
                  });
                  const data = await res.json();
                  setSchedules(prev => [...prev, data]);
                  showToast('æ’ç¨‹å·²å»ºç«‹ï¼', 'success');
                } catch (e) {
                  showToast('å»ºç«‹å¤±æ•—', 'error');
                }
              }}>
                {preset.label}
              </button>
            ))}
          </div>
        </div>
      )}
      
      <div className="card">
        <h3>ğŸ“… é¸æ“‡æ´»å‹•</h3>
        {activeEvents.length === 0 ? (
          <p style={{ color: '#64748b' }}>æ²’æœ‰é€²è¡Œä¸­çš„æ´»å‹•</p>
        ) : (
          <select style={{ width: '100%', padding: '12px', background: '#0f0f1a', border: '1px solid #3a3a4a', borderRadius: '10px', color: '#e2e8f0' }}
            value={selectedEvent} onChange={e => setSelectedEvent(e.target.value)}>
            <option value="">-- è«‹é¸æ“‡ --</option>
            {activeEvents.map(ev => <option key={ev.id} value={ev.id}>{ev.title}ï¼ˆ{ev.date}ï¼‰</option>)}
          </select>
        )}
        {selectedEventData && (
          <div style={{ marginTop: '15px', padding: '15px', background: '#0f0f1a', borderRadius: '10px' }}>
            <p>ğŸ“ {selectedEventData.location}</p>
            <p>â° {selectedEventData.time}{selectedEventData.endTime ? ' - ' + selectedEventData.endTime : ''}</p>
            <p>ğŸ‘¥ å·²ç¢ºèªå ±åï¼š{eventRegs.length} äºº</p>
          </div>
        )}
      </div>

      <div className="card">
        <h3>ğŸ“¨ é€šçŸ¥é¡å‹ï¼ˆæ‰‹å‹•ç™¼é€ï¼‰</h3>
        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '10px' }}>
          {Object.entries(typeLabels).map(([id, t]) => (
            <button key={id} className={`style-btn ${notifyType === id ? 'active' : ''}`} onClick={() => setNotifyType(id)} style={{ flex: '1', minWidth: '120px' }}>
              {t.icon} {t.label}<br/><small style={{ opacity: 0.7 }}>{t.desc}</small>
            </button>
          ))}
        </div>
      </div>

      <div className="card">
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px' }}>
          <h3 style={{ margin: 0 }}>ğŸ“ é€šçŸ¥å…§å®¹</h3>
          <button className="btn btn-secondary btn-sm" onClick={generateAIMessage} disabled={sending || !selectedEvent}>
            âœ¨ AI ç”Ÿæˆ
          </button>
        </div>
        <textarea rows="6" value={customMessage} onChange={e => setCustomMessage(e.target.value)}
          placeholder="è¼¸å…¥é€šçŸ¥å…§å®¹ï¼Œæˆ–é»æ“Šã€ŒAI ç”Ÿæˆã€è‡ªå‹•ç”¢ç”Ÿ..."
          style={{ width: '100%', padding: '15px', background: '#0f0f1a', border: '1px solid #3a3a4a', borderRadius: '10px', color: '#e2e8f0', resize: 'vertical' }} />
      </div>

      <div className="card">
        <h3>ğŸ“¤ ç«‹å³ç™¼é€</h3>
        <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
          <button className="btn btn-primary" onClick={sendReminder} disabled={sending || !selectedEvent || eventRegs.length === 0 || !customMessage.trim()}>
            {sending ? <><span className="loading"></span> ç™¼é€ä¸­...</> : `ğŸ“§ ç™¼é€ Emailï¼ˆ${eventRegs.length} äººï¼‰`}
          </button>
          <button className="btn btn-secondary" onClick={async () => {
            if (!selectedEvent || !customMessage.trim()) return;
            setSending(true);
            try {
              const res = await fetch('/api/send-line-notification', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ eventId: selectedEvent, message: customMessage })
              });
              const data = await res.json();
              showToast(data.success ? 'LINE é€šçŸ¥å·²ç™¼é€' : 'ç™¼é€å¤±æ•—', data.success ? 'success' : 'error');
            } catch (e) { showToast('ç™¼é€å¤±æ•—', 'error'); }
            setSending(false);
          }} disabled={sending || !selectedEvent || !customMessage.trim()}>
            ğŸ“± LINE é€šçŸ¥ç®¡ç†å“¡
          </button>
        </div>
      </div>

      {/* å»ºç«‹æ’ç¨‹ Modal */}
      {showScheduleModal && (
        <div className="modal-overlay" onClick={() => setShowScheduleModal(false)}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <h2>â° å»ºç«‹è‡ªå‹•æ’ç¨‹</h2>
            <p style={{ color: '#64748b', marginBottom: '20px' }}>
              è¨­å®šè‡ªå‹•ç™¼é€é€šçŸ¥çš„æ™‚é–“ï¼Œç³»çµ±æœƒåœ¨æŒ‡å®šæ™‚é–“è‡ªå‹•ç™¼é€ Email çµ¦æ‰€æœ‰å·²ç¢ºèªå­¸å“¡
            </p>
            
            <div className="form-group">
              <label>é€šçŸ¥é¡å‹</label>
              <select value={scheduleForm.type} onChange={e => setScheduleForm({...scheduleForm, type: e.target.value})}
                style={{ width: '100%', padding: '12px', background: '#0f0f1a', border: '1px solid #3a3a4a', borderRadius: '10px', color: '#e2e8f0' }}>
                {Object.entries(typeLabels).map(([id, t]) => (
                  <option key={id} value={id}>{t.icon} {t.label}</option>
                ))}
              </select>
            </div>

            {scheduleForm.type === 'feedback' ? (
              <div className="form-group">
                <label>æ´»å‹•çµæŸå¾Œå¹¾å¤©ç™¼é€</label>
                <select value={scheduleForm.daysAfter || 1} onChange={e => setScheduleForm({...scheduleForm, daysAfter: parseInt(e.target.value)})}
                  style={{ width: '100%', padding: '12px', background: '#0f0f1a', border: '1px solid #3a3a4a', borderRadius: '10px', color: '#e2e8f0' }}>
                  <option value={1}>æ´»å‹•å¾Œ 1 å¤©</option>
                  <option value={2}>æ´»å‹•å¾Œ 2 å¤©</option>
                  <option value={3}>æ´»å‹•å¾Œ 3 å¤©</option>
                  <option value={7}>æ´»å‹•å¾Œ 1 é€±</option>
                </select>
              </div>
            ) : (
              <div className="form-group">
                <label>æ´»å‹•å‰å¹¾å¤©ç™¼é€</label>
                <select value={scheduleForm.daysBefore} onChange={e => setScheduleForm({...scheduleForm, daysBefore: parseInt(e.target.value)})}
                  style={{ width: '100%', padding: '12px', background: '#0f0f1a', border: '1px solid #3a3a4a', borderRadius: '10px', color: '#e2e8f0' }}>
                  <option value={0}>æ´»å‹•ç•¶å¤©</option>
                  <option value={1}>æ´»å‹•å‰ 1 å¤©</option>
                  <option value={2}>æ´»å‹•å‰ 2 å¤©</option>
                  <option value={3}>æ´»å‹•å‰ 3 å¤©</option>
                  <option value={7}>æ´»å‹•å‰ 1 é€±</option>
                </select>
              </div>
            )}

            <div className="form-row">
              <div className="form-group">
                <label>ç™¼é€æ™‚é–“ï¼ˆå°æ™‚ï¼‰</label>
                <select value={scheduleForm.hour} onChange={e => setScheduleForm({...scheduleForm, hour: parseInt(e.target.value)})}
                  style={{ width: '100%', padding: '12px', background: '#0f0f1a', border: '1px solid #3a3a4a', borderRadius: '10px', color: '#e2e8f0' }}>
                  {[7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20].map(h => (
                    <option key={h} value={h}>{String(h).padStart(2, '0')}:00</option>
                  ))}
                </select>
              </div>
              <div className="form-group">
                <label>åˆ†é˜</label>
                <select value={scheduleForm.minute} onChange={e => setScheduleForm({...scheduleForm, minute: parseInt(e.target.value)})}
                  style={{ width: '100%', padding: '12px', background: '#0f0f1a', border: '1px solid #3a3a4a', borderRadius: '10px', color: '#e2e8f0' }}>
                  {[0, 15, 30, 45].map(m => (
                    <option key={m} value={m}>:{String(m).padStart(2, '0')}</option>
                  ))}
                </select>
              </div>
            </div>

            <div style={{ background: '#0f0f1a', padding: '15px', borderRadius: '10px', marginBottom: '20px' }}>
              <div style={{ color: '#64748b', fontSize: '14px' }}>
                ğŸ“… æ´»å‹•ï¼š{selectedEventData?.title}<br/>
                ğŸ“† æ´»å‹•æ—¥æœŸï¼š{selectedEventData?.date}<br/>
                â° é è¨ˆç™¼é€ï¼š{selectedEventData ? (() => {
                  const [year, month, day] = selectedEventData.date.split('-').map(Number);
                  const sendDate = new Date(year, month - 1, day);
                  if (scheduleForm.type === 'feedback') {
                    sendDate.setDate(sendDate.getDate() + (scheduleForm.daysAfter || 1));
                  } else {
                    sendDate.setDate(sendDate.getDate() - scheduleForm.daysBefore);
                  }
                  return `${sendDate.getFullYear()}/${sendDate.getMonth() + 1}/${sendDate.getDate()} ${String(scheduleForm.hour).padStart(2, '0')}:${String(scheduleForm.minute).padStart(2, '0')} (å°ç£æ™‚é–“)`;
                })() : '-'}
              </div>
            </div>

            <div style={{ display: 'flex', gap: '10px' }}>
              <button className="btn btn-primary" onClick={addSchedule}>âœ“ å»ºç«‹æ’ç¨‹</button>
              <button className="btn btn-secondary" onClick={() => setShowScheduleModal(false)}>å–æ¶ˆ</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// å­¸å“¡ä½œå“ç‰†
function ShowcasePage({ events, showToast }) {
  const [works, setWorks] = useState([]);
  const [showAdd, setShowAdd] = useState(false);
  const [form, setForm] = useState({ eventId: '', studentName: '', title: '', description: '', imageUrl: '', link: '' });

  useEffect(() => {
    fetch('/api/showcase').then(r => r.json()).then(data => setWorks(data || [])).catch(() => {});
  }, []);

  const addWork = async () => {
    if (!form.studentName || !form.title) { showToast('è«‹å¡«å¯«å­¸å“¡å§“åå’Œä½œå“æ¨™é¡Œ', 'error'); return; }
    try {
      const res = await fetch('/api/showcase', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ...form, createdAt: new Date().toISOString() })
      });
      const data = await res.json();
      setWorks(prev => [data, ...prev]);
      setForm({ eventId: '', studentName: '', title: '', description: '', imageUrl: '', link: '' });
      setShowAdd(false);
      showToast('ä½œå“å·²æ–°å¢ï¼', 'success');
    } catch (e) {
      showToast('æ–°å¢å¤±æ•—', 'error');
    }
  };

  const deleteWork = async (id) => {
    if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ä½œå“ï¼Ÿ')) return;
    try {
      await fetch(`/api/showcase/${id}`, { method: 'DELETE' });
      setWorks(prev => prev.filter(w => w.id !== id));
      showToast('å·²åˆªé™¤', 'success');
    } catch (e) {
      showToast('åˆªé™¤å¤±æ•—', 'error');
    }
  };

  const endedEvents = events.filter(e => e.status === 'ended');

  return (
    <div>
      <div className="header">
        <h1>ğŸª å­¸å“¡ä½œå“ç‰†</h1>
        <button className="btn btn-primary" onClick={() => setShowAdd(true)}>ï¼‹ æ–°å¢ä½œå“</button>
      </div>

      {works.length === 0 ? (
        <div className="card">
          <div className="empty-state">
            <div className="icon">ğŸ¨</div>
            <p>é‚„æ²’æœ‰å­¸å“¡ä½œå“</p>
            <button className="btn btn-primary" style={{ marginTop: '20px' }} onClick={() => setShowAdd(true)}>æ–°å¢ç¬¬ä¸€å€‹ä½œå“</button>
          </div>
        </div>
      ) : (
        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: '20px' }}>
          {works.map(work => {
            const ev = events.find(e => e.id === work.eventId);
            return (
              <div key={work.id} className="card" style={{ margin: 0 }}>
                {work.imageUrl && (
                  <div style={{ marginBottom: '15px', borderRadius: '10px', overflow: 'hidden' }}>
                    <img src={work.imageUrl} alt={work.title} style={{ width: '100%', height: '180px', objectFit: 'cover' }} />
                  </div>
                )}
                <h3 style={{ marginBottom: '10px' }}>{work.title}</h3>
                <p style={{ color: '#a5b4fc', marginBottom: '10px' }}>ğŸ‘¤ {work.studentName}</p>
                {ev && <p style={{ color: '#64748b', fontSize: '12px', marginBottom: '10px' }}>ğŸ“… {ev.title}</p>}
                {work.description && <p style={{ color: '#94a3b8', fontSize: '14px', marginBottom: '15px' }}>{work.description}</p>}
                <div style={{ display: 'flex', gap: '10px' }}>
                  {work.link && <a href={work.link} target="_blank" className="btn btn-secondary btn-sm">ğŸ”— æŸ¥çœ‹ä½œå“</a>}
                  <button className="btn btn-danger btn-sm" onClick={() => deleteWork(work.id)}>ğŸ—‘ï¸ åˆªé™¤</button>
                </div>
              </div>
            );
          })}
        </div>
      )}

      {showAdd && (
        <div className="modal-overlay" onClick={() => setShowAdd(false)}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <h2>â• æ–°å¢å­¸å“¡ä½œå“</h2>
            <div className="form-group">
              <label>ä¾†æºæ´»å‹•</label>
              <select value={form.eventId} onChange={e => setForm({...form, eventId: e.target.value})}
                style={{ width: '100%', padding: '12px', background: '#0f0f1a', border: '1px solid #3a3a4a', borderRadius: '10px', color: '#e2e8f0' }}>
                <option value="">-- é¸æ“‡æ´»å‹•ï¼ˆé¸å¡«ï¼‰--</option>
                {endedEvents.map(ev => <option key={ev.id} value={ev.id}>{ev.title}</option>)}
              </select>
            </div>
            <div className="form-group">
              <label>å­¸å“¡å§“å *</label>
              <input value={form.studentName} onChange={e => setForm({...form, studentName: e.target.value})} placeholder="ç‹å°æ˜" />
            </div>
            <div className="form-group">
              <label>ä½œå“æ¨™é¡Œ *</label>
              <input value={form.title} onChange={e => setForm({...form, title: e.target.value})} placeholder="æˆ‘çš„ AI ç¹ªåœ–ä½œå“" />
            </div>
            <div className="form-group">
              <label>ä½œå“èªªæ˜</label>
              <textarea rows="3" value={form.description} onChange={e => setForm({...form, description: e.target.value})} placeholder="æè¿°ä½œå“å…§å®¹..." />
            </div>
            <div className="form-group">
              <label>åœ–ç‰‡ç¶²å€</label>
              <input value={form.imageUrl} onChange={e => setForm({...form, imageUrl: e.target.value})} placeholder="https://..." />
            </div>
            <div className="form-group">
              <label>ä½œå“é€£çµ</label>
              <input value={form.link} onChange={e => setForm({...form, link: e.target.value})} placeholder="https://..." />
            </div>
            <div style={{ display: 'flex', gap: '10px', marginTop: '20px' }}>
              <button className="btn btn-primary" onClick={addWork}>å„²å­˜ä½œå“</button>
              <button className="btn btn-secondary" onClick={() => setShowAdd(false)}>å–æ¶ˆ</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// æ“ä½œæ‰‹å†Š
function GuidePage({ events, registrations, showToast }) {
  const [activeFeature, setActiveFeature] = useState(null);
  const [calendarUrl, setCalendarUrl] = useState('');
  const [faqList, setFaqList] = useState([
    { q: 'å¦‚ä½•å ±åï¼Ÿ', a: 'è«‹é»æ“Šå ±åé€£çµå¡«å¯«è¡¨å–®å³å¯å®Œæˆå ±åã€‚' },
    { q: 'å¯ä»¥å–æ¶ˆå ±åå—ï¼Ÿ', a: 'å¯ä»¥ï¼Œè«‹åˆ°å ±åé é¢è¼¸å…¥ Email æŸ¥è©¢ä¸¦å–æ¶ˆã€‚' },
    { q: 'æœƒæ”¶åˆ°é€šçŸ¥å—ï¼Ÿ', a: 'æœƒï¼Œå ±åæˆåŠŸå¾Œæœƒæ”¶åˆ°ç¢ºèªä¿¡ï¼Œæ´»å‹•å‰ä¹Ÿæœƒæ”¶åˆ°æé†’ã€‚' }
  ]);
  const [newFaq, setNewFaq] = useState({ q: '', a: '' });
  const [aiQuestion, setAiQuestion] = useState('');
  const [aiAnswer, setAiAnswer] = useState('');
  const [aiLoading, setAiLoading] = useState(false);
  const featureDetailRef = React.useRef(null);

  // é»æ“ŠåŠŸèƒ½å¡ç‰‡
  const handleFeatureClick = (featureId) => {
    const newActive = activeFeature === featureId ? null : featureId;
    setActiveFeature(newActive);
    
    // å¦‚æœå±•é–‹åŠŸèƒ½ï¼Œè‡ªå‹•æ»¾å‹•åˆ°åŠŸèƒ½è©³æƒ…
    if (newActive) {
      setTimeout(() => {
        if (featureDetailRef.current) {
          featureDetailRef.current.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }, 100);
    }
  };

  // è¨ˆç®—çµ±è¨ˆæ•¸æ“š
  const stats = {
    totalEvents: events.length,
    totalRegs: registrations.length,
    confirmed: registrations.filter(r => r.status === 'confirmed').length,
    cancelled: registrations.filter(r => r.status === 'cancelled').length,
    conversionRate: registrations.length > 0 ? Math.round((registrations.filter(r => r.status === 'confirmed').length / registrations.length) * 100) : 0,
    avgPerEvent: events.length > 0 ? Math.round(registrations.length / events.length) : 0
  };

  // æŒ‰æ´»å‹•çµ±è¨ˆ
  const eventStats = events.map(ev => {
    const evRegs = registrations.filter(r => r.eventId === ev.id);
    return {
      ...ev,
      total: evRegs.length,
      confirmed: evRegs.filter(r => r.status === 'confirmed').length,
      rate: evRegs.length > 0 ? Math.round((evRegs.filter(r => r.status === 'confirmed').length / evRegs.length) * 100) : 0
    };
  });

  // ç”Ÿæˆ Google Calendar é€£çµï¼ˆæ­£ç¢ºæ ¼å¼ï¼‰
  const generateCalendarLink = (ev) => {
    // è§£ææ—¥æœŸ YYYY-MM-DD
    const [year, month, day] = ev.date.split('-');
    // è§£ææ™‚é–“ HH:MM
    const [startH, startM] = (ev.time || '09:00').split(':');
    const [endH, endM] = (ev.endTime || '17:00').split(':');
    
    // Google Calendar æ ¼å¼: YYYYMMDDTHHMMSS
    const startDateTime = `${year}${month}${day}T${startH}${startM}00`;
    const endDateTime = `${year}${month}${day}T${endH}${endM}00`;
    
    // ä½¿ç”¨ www.google.com å’Œæ­£ç¢ºçš„è·¯å¾‘
    const baseUrl = 'https://www.google.com/calendar/render';
    const params = [
      'action=TEMPLATE',
      `text=${encodeURIComponent(ev.title)}`,
      `dates=${startDateTime}/${endDateTime}`,
      `ctz=Asia/Taipei`
    ];
    if (ev.location) params.push(`location=${encodeURIComponent(ev.location)}`);
    if (ev.description) params.push(`details=${encodeURIComponent(ev.description)}`);
    
    return `${baseUrl}?${params.join('&')}`;
  };

  // AI å®¢æœå›ç­”
  const askAI = async () => {
    if (!aiQuestion.trim()) return;
    setAiLoading(true);
    try {
      const res = await fetch('/api/ai-support', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question: aiQuestion, faqList, events })
      });
      const data = await res.json();
      setAiAnswer(data.answer || 'æŠ±æ­‰ï¼Œç„¡æ³•å›ç­”æ­¤å•é¡Œã€‚');
    } catch (e) {
      setAiAnswer('AI æœå‹™æš«æ™‚ç„¡æ³•ä½¿ç”¨ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
    }
    setAiLoading(false);
  };

  // åŒ¯å‡ºå­¸ç¿’æ­·ç¨‹
  const exportLearningHistory = (studentEmail) => {
    const studentRegs = registrations.filter(r => r.email === studentEmail && r.status === 'confirmed');
    const history = studentRegs.map(r => {
      const ev = events.find(e => e.id === r.eventId);
      return { event: ev?.title || 'æœªçŸ¥æ´»å‹•', date: ev?.date || '', status: 'å·²å®Œæˆ' };
    });
    const csv = [['æ´»å‹•åç¨±', 'æ—¥æœŸ', 'ç‹€æ…‹'], ...history.map(h => [h.event, h.date, h.status])].map(row => row.join(',')).join('\n');
    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `å­¸ç¿’æ­·ç¨‹_${studentEmail}.csv`;
    a.click();
    showToast('å­¸ç¿’æ­·ç¨‹å·²åŒ¯å‡º', 'success');
  };

  const features = [
    { id: 'calendar', icon: 'ğŸ“…', title: 'æ•´åˆ Google Calendar', desc: 'æ´»å‹•è‡ªå‹•åŒæ­¥åˆ°è¡Œäº‹æ›†', color: '#4285f4' },
    { id: 'analytics', icon: 'ğŸ“Š', title: 'å ±åæ•¸æ“šåˆ†æ', desc: 'å­¸å“¡ä¾†æºã€è½‰æ›ç‡çµ±è¨ˆ', color: '#ea4335' },
    { id: 'ai-support', icon: 'ğŸ¤–', title: 'AI å®¢æœæ©Ÿå™¨äºº', desc: 'è‡ªå‹•å›ç­”å¸¸è¦‹å•é¡Œ', color: '#34a853' },
    { id: 'payment', icon: 'ğŸ’³', title: 'ç·šä¸Šä»˜æ¬¾æ•´åˆ', desc: 'ä¸²æ¥é‡‘æµæ”¶å–å ±åè²»', color: '#fbbc05' },
    { id: 'course', icon: 'ğŸ“¹', title: 'ç·šä¸Šèª²ç¨‹å¹³å°', desc: 'æ•´åˆéŒ„å½±ã€ç›´æ’­åŠŸèƒ½', color: '#9c27b0' },
    { id: 'history', icon: 'ğŸ…', title: 'å­¸ç¿’æ­·ç¨‹è¨˜éŒ„', desc: 'è¿½è¹¤å­¸å“¡å­¸ç¿’é€²åº¦', color: '#ff5722' }
  ];

  const guides = [
    { title: 'ğŸš€ å¿«é€Ÿé–‹å§‹', steps: ['1. æ–°å¢æ´»å‹•', '2. è¨­ç‚ºé€²è¡Œä¸­', '3. åˆ†äº«å ±åé€£çµ', '4. ç¢ºèªå ±å', '5. ç™¼é€é€šçŸ¥', '6. ç™¼é€è­‰æ›¸'] },
    { title: 'ğŸ“± LINE Bot', steps: ['â€¢ ç¸½è¦½ - ç³»çµ±çµ±è¨ˆ', 'â€¢ æ´»å‹•åˆ—è¡¨ - ç®¡ç†æ´»å‹•', 'â€¢ æœ€æ–°å ±å - å ±åè³‡æ–™', 'â€¢ é€šçŸ¥ - ç™¼é€æé†’', 'â€¢ è­‰æ›¸ - ç™¼é€è­‰æ›¸'] }
  ];

  return (
    <div>
      <div className="header">
        <h1>ğŸ“– æ“ä½œæ‰‹å†Š & é€²éšåŠŸèƒ½</h1>
      </div>

      {/* åŠŸèƒ½å¡ç‰‡ */}
      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(160px, 1fr))', gap: '15px', marginBottom: '20px' }}>
        {features.map(f => (
          <div key={f.id} onClick={() => handleFeatureClick(f.id)}
            style={{ background: activeFeature === f.id ? f.color : '#1a1a2e', padding: '20px', borderRadius: '12px', cursor: 'pointer', border: `2px solid ${activeFeature === f.id ? f.color : '#2a2a4a'}`, transition: 'all 0.3s', position: 'relative' }}>
            <div style={{ fontSize: '32px', marginBottom: '10px' }}>{f.icon}</div>
            <div style={{ fontWeight: 'bold', marginBottom: '5px' }}>{f.title}</div>
            <div style={{ fontSize: '12px', color: activeFeature === f.id ? '#fff' : '#64748b' }}>{f.desc}</div>
            {activeFeature === f.id && (
              <div style={{ position: 'absolute', bottom: '5px', right: '10px', fontSize: '10px', color: '#fff' }}>â–¼ å±•é–‹ä¸­</div>
            )}
          </div>
        ))}
      </div>

      {/* åŠŸèƒ½è©³æƒ… - åŠ å…¥ ref æ–¹ä¾¿æ»¾å‹• */}
      <div ref={featureDetailRef}>
      {activeFeature === 'calendar' && (
        <div className="card">
          <h3>ğŸ“… æ•´åˆ Google Calendar</h3>
          <p style={{ color: '#94a3b8', marginBottom: '15px' }}>é¸æ“‡æ´»å‹•ï¼Œä¸€éµåŠ å…¥ Google è¡Œäº‹æ›†</p>
          {events.filter(e => e.status === 'active').length === 0 ? (
            <p style={{ color: '#64748b' }}>æ²’æœ‰é€²è¡Œä¸­çš„æ´»å‹•</p>
          ) : (
            <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
              {events.filter(e => e.status === 'active').map(ev => (
                <div key={ev.id} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', background: '#0f0f1a', padding: '15px', borderRadius: '10px' }}>
                  <div>
                    <strong>{ev.title}</strong>
                    <div style={{ fontSize: '12px', color: '#64748b' }}>{ev.date} {ev.time}</div>
                  </div>
                  <a href={generateCalendarLink(ev)} target="_blank" className="btn btn-primary btn-sm">ğŸ“… åŠ å…¥è¡Œäº‹æ›†</a>
                </div>
              ))}
            </div>
          )}
        </div>
      )}

      {activeFeature === 'analytics' && (
        <div className="card">
          <h3>ğŸ“Š å ±åæ•¸æ“šåˆ†æ</h3>
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(120px, 1fr))', gap: '15px', marginBottom: '20px' }}>
            <div style={{ background: '#0f0f1a', padding: '15px', borderRadius: '10px', textAlign: 'center' }}>
              <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#6366f1' }}>{stats.totalEvents}</div>
              <div style={{ fontSize: '12px', color: '#64748b' }}>æ´»å‹•ç¸½æ•¸</div>
            </div>
            <div style={{ background: '#0f0f1a', padding: '15px', borderRadius: '10px', textAlign: 'center' }}>
              <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#10b981' }}>{stats.totalRegs}</div>
              <div style={{ fontSize: '12px', color: '#64748b' }}>ç¸½å ±åæ•¸</div>
            </div>
            <div style={{ background: '#0f0f1a', padding: '15px', borderRadius: '10px', textAlign: 'center' }}>
              <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#f59e0b' }}>{stats.conversionRate}%</div>
              <div style={{ fontSize: '12px', color: '#64748b' }}>ç¢ºèªç‡</div>
            </div>
            <div style={{ background: '#0f0f1a', padding: '15px', borderRadius: '10px', textAlign: 'center' }}>
              <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#ec4899' }}>{stats.avgPerEvent}</div>
              <div style={{ fontSize: '12px', color: '#64748b' }}>å¹³å‡å ±å/æ´»å‹•</div>
            </div>
          </div>
          <h4>å„æ´»å‹•è½‰æ›ç‡</h4>
          <table>
            <thead><tr><th>æ´»å‹•</th><th>å ±å</th><th>ç¢ºèª</th><th>è½‰æ›ç‡</th></tr></thead>
            <tbody>
              {eventStats.map(ev => (
                <tr key={ev.id}>
                  <td>{ev.title}</td>
                  <td>{ev.total}</td>
                  <td>{ev.confirmed}</td>
                  <td><span className={`badge ${ev.rate >= 80 ? 'badge-green' : ev.rate >= 50 ? 'badge-yellow' : 'badge-red'}`}>{ev.rate}%</span></td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      {activeFeature === 'ai-support' && (
        <div className="card">
          <h3>ğŸ¤– AI å®¢æœæ©Ÿå™¨äºº</h3>
          <div style={{ marginBottom: '20px' }}>
            <h4>å¸¸è¦‹å•é¡Œç®¡ç†</h4>
            {faqList.map((faq, i) => (
              <div key={i} style={{ background: '#0f0f1a', padding: '15px', borderRadius: '10px', marginBottom: '10px' }}>
                <div style={{ fontWeight: 'bold', color: '#a5b4fc' }}>Q: {faq.q}</div>
                <div style={{ color: '#94a3b8', marginTop: '5px' }}>A: {faq.a}</div>
                <button className="btn btn-danger btn-sm" style={{ marginTop: '10px' }} onClick={() => setFaqList(faqList.filter((_, j) => j !== i))}>åˆªé™¤</button>
              </div>
            ))}
            <div style={{ display: 'flex', gap: '10px', marginTop: '15px', flexWrap: 'wrap' }}>
              <input placeholder="å•é¡Œ" value={newFaq.q} onChange={e => setNewFaq({...newFaq, q: e.target.value})} style={{ flex: 1, minWidth: '150px' }} />
              <input placeholder="ç­”æ¡ˆ" value={newFaq.a} onChange={e => setNewFaq({...newFaq, a: e.target.value})} style={{ flex: 2, minWidth: '200px' }} />
              <button className="btn btn-primary btn-sm" onClick={() => { if (newFaq.q && newFaq.a) { setFaqList([...faqList, newFaq]); setNewFaq({ q: '', a: '' }); } }}>æ–°å¢</button>
            </div>
          </div>
          <div style={{ borderTop: '1px solid #2a2a4a', paddingTop: '20px' }}>
            <h4>æ¸¬è©¦ AI å›ç­”</h4>
            <div style={{ display: 'flex', gap: '10px', marginBottom: '15px' }}>
              <input placeholder="è¼¸å…¥å­¸å“¡å¯èƒ½å•çš„å•é¡Œ..." value={aiQuestion} onChange={e => setAiQuestion(e.target.value)} style={{ flex: 1 }} />
              <button className="btn btn-primary" onClick={askAI} disabled={aiLoading}>{aiLoading ? 'æ€è€ƒä¸­...' : 'ğŸ¤– AI å›ç­”'}</button>
            </div>
            {aiAnswer && (
              <div style={{ background: '#0f0f1a', padding: '15px', borderRadius: '10px' }}>
                <div style={{ color: '#10b981', fontWeight: 'bold' }}>AI å›ç­”ï¼š</div>
                <div style={{ color: '#e2e8f0', marginTop: '10px' }}>{aiAnswer}</div>
              </div>
            )}
          </div>
        </div>
      )}

      {activeFeature === 'payment' && (
        <div className="card">
          <h3>ğŸ’³ ç·šä¸Šä»˜æ¬¾æ•´åˆ</h3>
          <div style={{ background: '#0f0f1a', padding: '20px', borderRadius: '10px' }}>
            <p style={{ color: '#f59e0b', marginBottom: '15px' }}>âš ï¸ ä»˜æ¬¾åŠŸèƒ½éœ€è¦é¡å¤–ä¸²æ¥é‡‘æµæœå‹™</p>
            <h4>æ”¯æ´çš„é‡‘æµå¹³å°ï¼š</h4>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))', gap: '15px', marginTop: '15px' }}>
              {[
                { name: 'ç¶ ç•Œ ECPay', url: 'https://www.ecpay.com.tw/', desc: 'å°ç£æœ€å¤§ç¬¬ä¸‰æ–¹æ”¯ä»˜' },
                { name: 'è—æ–° NewebPay', url: 'https://www.newebpay.com/', desc: 'å¤šå…ƒæ”¯ä»˜æ•´åˆ' },
                { name: 'LINE Pay', url: 'https://pay.line.me/', desc: 'LINE ç”¨æˆ¶ä¾¿æ·æ”¯ä»˜' },
                { name: 'Stripe', url: 'https://stripe.com/', desc: 'åœ‹éš›ä¿¡ç”¨å¡æ”¯ä»˜' }
              ].map((p, i) => (
                <a key={i} href={p.url} target="_blank" style={{ background: '#1a1a2e', padding: '15px', borderRadius: '10px', textDecoration: 'none' }}>
                  <div style={{ fontWeight: 'bold', color: '#a5b4fc' }}>{p.name}</div>
                  <div style={{ fontSize: '12px', color: '#64748b' }}>{p.desc}</div>
                </a>
              ))}
            </div>
            <div style={{ marginTop: '20px', padding: '15px', background: '#1a1a2e', borderRadius: '10px' }}>
              <h4>æ•´åˆæ­¥é©Ÿï¼š</h4>
              <ol style={{ color: '#94a3b8', paddingLeft: '20px', lineHeight: '2' }}>
                <li>ç”³è«‹é‡‘æµå¹³å°å•†æˆ¶å¸³è™Ÿ</li>
                <li>å–å¾— API Key å’Œ Secret</li>
                <li>åœ¨ Render ç’°å¢ƒè®Šæ•¸è¨­å®šé‡‘æµåƒæ•¸</li>
                <li>åœ¨æ´»å‹•è¨­å®šä¸­å•Ÿç”¨ä»˜æ¬¾åŠŸèƒ½</li>
              </ol>
            </div>
          </div>
        </div>
      )}

      {activeFeature === 'course' && (
        <div className="card">
          <h3>ğŸ“¹ ç·šä¸Šèª²ç¨‹å¹³å°</h3>
          <div style={{ background: '#0f0f1a', padding: '20px', borderRadius: '10px' }}>
            <h4>æ”¯æ´çš„å¹³å°æ•´åˆï¼š</h4>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))', gap: '15px', marginTop: '15px' }}>
              {[
                { name: 'Google Meet', icon: 'ğŸ“¹', desc: 'å…è²»è¦–è¨Šæœƒè­°', action: () => window.open('https://meet.google.com/new', '_blank') },
                { name: 'YouTube ç›´æ’­', icon: 'ğŸ”´', desc: 'å¤§å‹æ´»å‹•ç›´æ’­', action: () => window.open('https://studio.youtube.com/', '_blank') },
                { name: 'Zoom', icon: 'ğŸ’»', desc: 'å°ˆæ¥­æœƒè­°ç³»çµ±', action: () => window.open('https://zoom.us/', '_blank') },
                { name: 'OBS Studio', icon: 'ğŸ¬', desc: 'å°ˆæ¥­éŒ„å½±è»Ÿé«”', action: () => window.open('https://obsproject.com/', '_blank') }
              ].map((p, i) => (
                <div key={i} onClick={p.action} style={{ background: '#1a1a2e', padding: '15px', borderRadius: '10px', cursor: 'pointer' }}>
                  <div style={{ fontSize: '24px' }}>{p.icon}</div>
                  <div style={{ fontWeight: 'bold', color: '#a5b4fc', marginTop: '10px' }}>{p.name}</div>
                  <div style={{ fontSize: '12px', color: '#64748b' }}>{p.desc}</div>
                </div>
              ))}
            </div>
            <div style={{ marginTop: '20px' }}>
              <h4>å¿«é€Ÿå»ºç«‹æœƒè­°é€£çµ</h4>
              <button className="btn btn-primary" style={{ marginTop: '10px' }} onClick={() => window.open('https://meet.google.com/new', '_blank')}>
                ğŸ“¹ å»ºç«‹ Google Meet
              </button>
            </div>
          </div>
        </div>
      )}

      {activeFeature === 'history' && (
        <div className="card">
          <h3>ğŸ… å­¸ç¿’æ­·ç¨‹è¨˜éŒ„</h3>
          <p style={{ color: '#94a3b8', marginBottom: '15px' }}>æŸ¥è©¢å­¸å“¡åƒèˆ‡éçš„æ‰€æœ‰æ´»å‹•</p>
          {(() => {
            const uniqueEmails = [...new Set(registrations.filter(r => r.status === 'confirmed').map(r => r.email))];
            return uniqueEmails.length === 0 ? (
              <p style={{ color: '#64748b' }}>æ²’æœ‰å­¸å“¡è³‡æ–™</p>
            ) : (
              <table>
                <thead><tr><th>å­¸å“¡ Email</th><th>åƒèˆ‡æ´»å‹•æ•¸</th><th>æ“ä½œ</th></tr></thead>
                <tbody>
                  {uniqueEmails.map(email => {
                    const count = registrations.filter(r => r.email === email && r.status === 'confirmed').length;
                    const name = registrations.find(r => r.email === email)?.name || '';
                    return (
                      <tr key={email}>
                        <td><strong>{name}</strong><br/><span style={{ fontSize: '12px', color: '#64748b' }}>{email}</span></td>
                        <td><span className="badge badge-green">{count} å ´</span></td>
                        <td><button className="btn btn-secondary btn-sm" onClick={() => exportLearningHistory(email)}>ğŸ“¥ åŒ¯å‡ºæ­·ç¨‹</button></td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            );
          })()}
        </div>
      )}
      </div>

      {/* æ“ä½œæŒ‡å— */}
      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: '20px', marginTop: '20px' }}>
        {guides.map((guide, i) => (
          <div key={i} className="card" style={{ margin: 0 }}>
            <h3>{guide.title}</h3>
            <div style={{ color: '#94a3b8', lineHeight: '2' }}>
              {guide.steps.map((step, j) => <div key={j}>{step}</div>)}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

// æ‰‹æ©Ÿç‰ˆåº•éƒ¨å°èˆª
function MobileNav({ page, setPage }) {
  const items = [
    { id: 'dashboard', icon: 'ğŸ“Š', label: 'é¦–é ' },
    { id: 'events', icon: 'ğŸ“…', label: 'æ´»å‹•' },
    { id: 'registrations', icon: 'ğŸ“‹', label: 'å ±å' },
    { id: 'notifications', icon: 'ğŸ””', label: 'é€šçŸ¥' },
    { id: 'showcase', icon: 'ğŸª', label: 'ä½œå“' },
    { id: 'more', icon: 'â‹¯', label: 'æ›´å¤š' }
  ];
  const [showMore, setShowMore] = useState(false);
  
  const moreItems = [
    { id: 'poster', icon: 'ğŸ¨', label: 'AI æ–‡å®£' },
    { id: 'certificates', icon: 'ğŸ†', label: 'è­‰æ›¸' },
    { id: 'guide', icon: 'ğŸ“–', label: 'æ‰‹å†Š' },
    { id: 'settings', icon: 'âš™ï¸', label: 'è¨­å®š' }
  ];
  
  return (
    <>
      {showMore && (
        <div style={{ position: 'fixed', bottom: '70px', left: 0, right: 0, background: '#1a1a2e', borderTop: '1px solid #2a2a4a', padding: '10px', zIndex: 999 }}>
          <div style={{ display: 'flex', justifyContent: 'space-around' }}>
            {moreItems.map(item => (
              <div key={item.id} className={`mobile-nav-item ${page === item.id ? 'active' : ''}`} onClick={() => { setPage(item.id); setShowMore(false); }}>
                <span>{item.icon}</span>{item.label}
              </div>
            ))}
          </div>
        </div>
      )}
      <div className="mobile-nav">
        <div className="mobile-nav-inner">
          {items.map(item => (
            item.id === 'more' ? (
              <div key={item.id} className={`mobile-nav-item ${showMore ? 'active' : ''}`} onClick={() => setShowMore(!showMore)}>
                <span>{item.icon}</span>{item.label}
              </div>
            ) : (
              <div key={item.id} className={`mobile-nav-item ${page === item.id ? 'active' : ''}`} onClick={() => { setPage(item.id); setShowMore(false); }}>
                <span>{item.icon}</span>{item.label}
              </div>
            )
          ))}
        </div>
      </div>
    </>
  );
}

// ä¸»ç¨‹å¼
function App() {
  const [page, setPage] = useState('dashboard');
  const [events, setEvents] = useState([]);
  const [registrations, setRegistrations] = useState([]);
  const [status, setStatus] = useState({ firebase: false, openai: false, gemini: false });
  const [toast, setToast] = useState(null);

  // æª¢æŸ¥æ˜¯å¦ç‚ºå…¬é–‹å ±åé é¢
  const urlParams = new URLSearchParams(window.location.search);
  const registerEventId = urlParams.get('register');

  const showToast = (message, type) => setToast({ message, type });
  
  const refresh = async () => {
    try {
      const [evs, regs, st] = await Promise.all([API.getEvents(), API.getRegistrations(), API.getStatus()]);
      setEvents(evs);
      setRegistrations(regs);
      setStatus(st);
    } catch (e) {
      console.error('Refresh error:', e);
    }
  };

  useEffect(() => { refresh(); }, []);

  // å¦‚æœæ˜¯å…¬é–‹å ±åé é¢ï¼Œé¡¯ç¤ºå ±åè¡¨å–®
  if (registerEventId) {
    return <PublicRegisterForm eventId={registerEventId} />;
  }

  return (
    <div className="app">
      <Sidebar page={page} setPage={setPage} />
      <div className="main">
        {page === 'dashboard' && <Dashboard events={events} registrations={registrations} status={status} />}
        {page === 'events' && <EventsPage events={events} onRefresh={refresh} showToast={showToast} />}
        {page === 'registrations' && <RegistrationsPage events={events} registrations={registrations} onRefresh={refresh} showToast={showToast} />}
        {page === 'notifications' && <NotificationsPage events={events} registrations={registrations} showToast={showToast} />}
        {page === 'poster' && <PosterPage events={events} showToast={showToast} />}
        {page === 'certificates' && <CertificatesPage events={events} registrations={registrations} showToast={showToast} />}
        {page === 'showcase' && <ShowcasePage events={events} showToast={showToast} />}
        {page === 'guide' && <GuidePage events={events} registrations={registrations} showToast={showToast} />}
        {page === 'settings' && <SettingsPage status={status} />}
      </div>
      <MobileNav page={page} setPage={setPage} />
      {toast && <Toast {...toast} onClose={() => setToast(null)} />}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
