<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“ å·¥ä½œåŠç®¡ç†ç³»çµ±</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', 'Noto Sans TC', sans-serif; background: #0f0f1a; color: #e2e8f0; min-height: 100vh; }
        .app { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%); padding: 20px; border-right: 1px solid #2a2a4a; display: flex; flex-direction: column; }
        .logo { font-size: 24px; font-weight: 700; margin-bottom: 40px; background: linear-gradient(135deg, #6366f1, #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .nav-item { padding: 14px 18px; margin: 4px 0; border-radius: 12px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 12px; color: #94a3b8; }
        .nav-item:hover { background: rgba(99, 102, 241, 0.1); color: #e2e8f0; }
        .nav-item.active { background: linear-gradient(135deg, #6366f1, #a855f7); color: #fff; }
        .main { flex: 1; padding: 30px; overflow-y: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { font-size: 28px; }
        .status-badge { padding: 8px 16px; border-radius: 20px; font-size: 13px; display: flex; align-items: center; gap: 8px; }
        .status-firebase { background: rgba(249, 115, 22, 0.2); color: #f97316; }
        .status-openai { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #1e1e2e 0%, #2a2a3a 100%); padding: 24px; border-radius: 16px; border: 1px solid #3a3a4a; }
        .stat-card .icon { font-size: 32px; margin-bottom: 12px; }
        .stat-card .value { font-size: 36px; font-weight: 700; background: linear-gradient(135deg, #6366f1, #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stat-card .label { color: #64748b; margin-top: 4px; }
        .card { background: #1e1e2e; border-radius: 16px; border: 1px solid #2a2a3a; padding: 24px; margin-bottom: 20px; }
        .card h3 { margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .btn { padding: 12px 24px; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, #6366f1, #a855f7); color: #fff; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3); }
        .btn-secondary { background: #2a2a3a; color: #e2e8f0; }
        .btn-secondary:hover { background: #3a3a4a; }
        .btn-success { background: linear-gradient(135deg, #10b981, #059669); color: #fff; }
        .btn-danger { background: #ef4444; color: #fff; }
        .btn-sm { padding: 8px 16px; font-size: 13px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 14px; text-align: left; border-bottom: 1px solid #2a2a3a; }
        th { color: #64748b; font-weight: 600; }
        .badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge-green { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .badge-yellow { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .badge-gray { background: rgba(100, 116, 139, 0.2); color: #64748b; }
        .badge-red { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: #1e1e2e; border-radius: 20px; padding: 30px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .modal h2 { margin-bottom: 24px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #94a3b8; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 16px; background: #0f0f1a; border: 1px solid #3a3a4a; border-radius: 10px; color: #e2e8f0; font-size: 15px; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #6366f1; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .toast { position: fixed; bottom: 30px; right: 30px; padding: 16px 24px; border-radius: 12px; color: #fff; font-weight: 500; z-index: 2000; animation: slideIn 0.3s; }
        .toast-success { background: linear-gradient(135deg, #10b981, #059669); }
        .toast-error { background: #ef4444; }
        @keyframes slideIn { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .empty-state { text-align: center; padding: 60px 20px; color: #64748b; }
        .empty-state .icon { font-size: 64px; margin-bottom: 20px; }
        .ai-output { background: #0f0f1a; border-radius: 12px; padding: 20px; white-space: pre-wrap; line-height: 1.8; max-height: 400px; overflow-y: auto; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .style-btn { padding: 10px 20px; margin: 5px; border-radius: 20px; border: 2px solid #3a3a4a; background: transparent; color: #94a3b8; cursor: pointer; transition: all 0.2s; }
        .style-btn:hover, .style-btn.active { border-color: #6366f1; background: rgba(99, 102, 241, 0.1); color: #6366f1; }
        @media (max-width: 768px) { .sidebar { display: none; } .form-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect } = React;

// API å‘¼å«
const API = {
  async getEvents() {
    const res = await fetch('/api/events');
    return res.json();
  },
  async addEvent(data) {
    const res = await fetch('/api/events', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
    return res.json();
  },
  async updateEvent(id, data) {
    const res = await fetch(`/api/events/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
    return res.json();
  },
  async getRegistrations(eventId) {
    const url = eventId ? `/api/registrations?eventId=${eventId}` : '/api/registrations';
    const res = await fetch(url);
    return res.json();
  },
  async addRegistration(data) {
    const res = await fetch('/api/registrations', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
    return res.json();
  },
  async getStatus() {
    const res = await fetch('/api/status');
    return res.json();
  }
};

// Toast é€šçŸ¥
function Toast({ message, type, onClose }) {
  useEffect(() => { const t = setTimeout(onClose, 3000); return () => clearTimeout(t); }, []);
  return <div className={`toast toast-${type}`}>{message}</div>;
}

// å…¬é–‹å ±åè¡¨å–®
function PublicRegisterForm({ eventId, onSuccess }) {
  const [event, setEvent] = useState(null);
  const [form, setForm] = useState({ name: '', email: '', phone: '' });
  const [loading, setLoading] = useState(true);
  const [submitting, setSubmitting] = useState(false);
  const [submitted, setSubmitted] = useState(false);
  const [mode, setMode] = useState('register'); // register, check, cancelled
  const [foundReg, setFoundReg] = useState(null);

  useEffect(() => {
    API.getEvents().then(events => {
      const ev = events.find(e => e.id === eventId);
      setEvent(ev);
      setLoading(false);
    });
  }, [eventId]);

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!form.name || !form.email) { alert('è«‹å¡«å¯«å§“åå’Œ Email'); return; }
    setSubmitting(true);
    try {
      await API.addRegistration({ ...form, eventId });
      setSubmitted(true);
    } catch (err) {
      alert('å ±åå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
    setSubmitting(false);
  };

  const checkRegistration = async (e) => {
    e.preventDefault();
    if (!form.email) { alert('è«‹å¡«å¯« Email'); return; }
    setSubmitting(true);
    try {
      const res = await fetch(`/api/registrations/check?email=${encodeURIComponent(form.email)}&eventId=${eventId}`);
      const data = await res.json();
      if (data.found) {
        setFoundReg(data.registration);
      } else {
        alert('æ‰¾ä¸åˆ°æ‚¨çš„å ±åç´€éŒ„');
      }
    } catch (err) {
      alert('æŸ¥è©¢å¤±æ•—');
    }
    setSubmitting(false);
  };

  const cancelRegistration = async () => {
    if (!confirm('ç¢ºå®šè¦å–æ¶ˆå ±åå—ï¼Ÿ')) return;
    setSubmitting(true);
    try {
      await fetch(`/api/registrations/${foundReg.id}/cancel`, { method: 'POST' });
      setMode('cancelled');
    } catch (err) {
      alert('å–æ¶ˆå¤±æ•—');
    }
    setSubmitting(false);
  };

  if (loading) return <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '100vh', background: '#0f0f1a' }}><div className="loading" style={{ width: '40px', height: '40px', borderColor: '#6366f1', borderTopColor: 'transparent' }}></div></div>;

  if (!event || event.status !== 'active') {
    return (
      <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '100vh', background: '#0f0f1a' }}>
        <div className="card" style={{ maxWidth: '500px', textAlign: 'center' }}>
          <div style={{ fontSize: '64px', marginBottom: '20px' }}>ğŸ˜¢</div>
          <h2 style={{ marginBottom: '16px' }}>æ´»å‹•ä¸å­˜åœ¨æˆ–å·²çµæŸ</h2>
          <p style={{ color: '#64748b' }}>æ­¤å ±åé€£çµå·²å¤±æ•ˆ</p>
        </div>
      </div>
    );
  }

  if (mode === 'cancelled') {
    return (
      <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '100vh', background: '#0f0f1a' }}>
        <div className="card" style={{ maxWidth: '500px', textAlign: 'center' }}>
          <div style={{ fontSize: '64px', marginBottom: '20px' }}>ğŸ‘‹</div>
          <h2 style={{ marginBottom: '16px' }}>å·²å–æ¶ˆå ±å</h2>
          <p style={{ color: '#94a3b8' }}>æ‚¨çš„å ±åå·²æˆåŠŸå–æ¶ˆï¼ŒæœŸå¾…ä¸‹æ¬¡åƒèˆ‡ï¼</p>
        </div>
      </div>
    );
  }

  if (submitted) {
    return (
      <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '100vh', background: '#0f0f1a' }}>
        <div className="card" style={{ maxWidth: '500px', textAlign: 'center' }}>
          <div style={{ fontSize: '64px', marginBottom: '20px' }}>ğŸ‰</div>
          <h2 style={{ marginBottom: '16px', color: '#10b981' }}>å ±åæˆåŠŸï¼</h2>
          <p style={{ color: '#94a3b8', marginBottom: '20px' }}>æˆ‘å€‘å·²æ”¶åˆ°æ‚¨çš„å ±åï¼Œç¢ºèªä¿¡å·²å¯„é€è‡³æ‚¨çš„ Emailã€‚</p>
          <div style={{ background: '#1a1a2e', borderRadius: '12px', padding: '20px', textAlign: 'left' }}>
            <p><strong>æ´»å‹•ï¼š</strong>{event.title}</p>
            <p><strong>æ™‚é–“ï¼š</strong>{event.date} {event.time}{event.endTime ? ' - ' + event.endTime : ''}</p>
            <p><strong>åœ°é»ï¼š</strong>{event.location}</p>
          </div>
        </div>
      </div>
    );
  }

  const spotsLeft = event.maxParticipants - (event.registrations || 0);

  return (
    <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '100vh', background: '#0f0f1a', padding: '20px' }}>
      <div style={{ maxWidth: '500px', width: '100%' }}>
        <div className="card" style={{ marginBottom: '20px', background: 'linear-gradient(135deg, #6366f1, #a855f7)', border: 'none' }}>
          <h1 style={{ fontSize: '24px', marginBottom: '16px' }}>ğŸ“ æ´»å‹•å ±å</h1>
          <h2 style={{ fontSize: '20px', marginBottom: '12px' }}>{event.title}</h2>
          <p style={{ opacity: 0.9, marginBottom: '8px' }}>ğŸ“… {event.date} {event.time}{event.endTime ? ' - ' + event.endTime : ''}</p>
          <p style={{ opacity: 0.9, marginBottom: '8px' }}>ğŸ“ {event.location}</p>
          <p style={{ opacity: 0.9 }}>ğŸ‘¥ å‰©é¤˜åé¡ï¼š{spotsLeft > 0 ? spotsLeft : 'å·²é¡æ»¿'} / {event.maxParticipants}</p>
        </div>
        
        {/* åˆ‡æ›å ±å/æŸ¥è©¢ */}
        <div style={{ display: 'flex', marginBottom: '20px', gap: '10px' }}>
          <button className={`btn ${mode === 'register' ? 'btn-primary' : 'btn-secondary'}`} style={{ flex: 1 }} onClick={() => { setMode('register'); setFoundReg(null); }}>ğŸ“ æˆ‘è¦å ±å</button>
          <button className={`btn ${mode === 'check' ? 'btn-primary' : 'btn-secondary'}`} style={{ flex: 1 }} onClick={() => { setMode('check'); setFoundReg(null); }}>ğŸ” æŸ¥è©¢/å–æ¶ˆ</button>
        </div>

        {mode === 'register' && (
          spotsLeft <= 0 ? (
            <div className="card" style={{ textAlign: 'center' }}>
              <div style={{ fontSize: '48px', marginBottom: '16px' }}>ğŸ˜¢</div>
              <p>å¾ˆæŠ±æ­‰ï¼Œæ­¤æ´»å‹•å·²é¡æ»¿</p>
            </div>
          ) : (
            <div className="card">
              <h3 style={{ marginBottom: '20px' }}>å¡«å¯«å ±åè³‡æ–™</h3>
              <form onSubmit={handleSubmit}>
                <div className="form-group">
                  <label>å§“å *</label>
                  <input value={form.name} onChange={e => setForm({...form, name: e.target.value})} placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å" required />
                </div>
                <div className="form-group">
                  <label>Email *</label>
                  <input type="email" value={form.email} onChange={e => setForm({...form, email: e.target.value})} placeholder="example@mail.com" required />
                </div>
                <div className="form-group">
                  <label>æ‰‹æ©Ÿè™Ÿç¢¼</label>
                  <input value={form.phone} onChange={e => setForm({...form, phone: e.target.value})} placeholder="0912345678" />
                </div>
                <button type="submit" className="btn btn-primary" style={{ width: '100%', justifyContent: 'center' }} disabled={submitting}>
                  {submitting ? <><span className="loading"></span> é€å‡ºä¸­...</> : 'âœ… ç¢ºèªå ±å'}
                </button>
              </form>
            </div>
          )
        )}

        {mode === 'check' && !foundReg && (
          <div className="card">
            <h3 style={{ marginBottom: '20px' }}>æŸ¥è©¢å ±åç‹€æ…‹</h3>
            <form onSubmit={checkRegistration}>
              <div className="form-group">
                <label>å ±åæ™‚çš„ Email *</label>
                <input type="email" value={form.email} onChange={e => setForm({...form, email: e.target.value})} placeholder="example@mail.com" required />
              </div>
              <button type="submit" className="btn btn-primary" style={{ width: '100%', justifyContent: 'center' }} disabled={submitting}>
                {submitting ? <><span className="loading"></span> æŸ¥è©¢ä¸­...</> : 'ğŸ” æŸ¥è©¢å ±å'}
              </button>
            </form>
          </div>
        )}

        {mode === 'check' && foundReg && (
          <div className="card">
            <h3 style={{ marginBottom: '20px' }}>æ‚¨çš„å ±åè³‡æ–™</h3>
            <div style={{ background: '#0f0f1a', padding: '16px', borderRadius: '10px', marginBottom: '20px' }}>
              <p><strong>å§“åï¼š</strong>{foundReg.name}</p>
              <p><strong>Emailï¼š</strong>{foundReg.email}</p>
              <p><strong>é›»è©±ï¼š</strong>{foundReg.phone || '-'}</p>
              <p><strong>ç‹€æ…‹ï¼š</strong><span className={`badge ${foundReg.status === 'confirmed' ? 'badge-green' : foundReg.status === 'cancelled' ? 'badge-red' : 'badge-yellow'}`}>{foundReg.status === 'confirmed' ? 'å·²ç¢ºèª' : foundReg.status === 'cancelled' ? 'å·²å–æ¶ˆ' : 'å¾…ç¢ºèª'}</span></p>
            </div>
            {foundReg.status !== 'cancelled' && (
              <button className="btn btn-danger" style={{ width: '100%', justifyContent: 'center' }} onClick={cancelRegistration} disabled={submitting}>
                {submitting ? <><span className="loading"></span> è™•ç†ä¸­...</> : 'âŒ å–æ¶ˆå ±å'}
              </button>
            )}
          </div>
        )}
        
        {event.description && (
          <div className="card">
            <h3 style={{ marginBottom: '12px' }}>ğŸ“– æ´»å‹•èªªæ˜</h3>
            <p style={{ color: '#94a3b8', lineHeight: '1.8' }}>{event.description}</p>
          </div>
        )}
      </div>
    </div>
  );
}

// å´é‚Šæ¬„
function Sidebar({ page, setPage }) {
  const items = [
    { id: 'dashboard', icon: 'ğŸ“Š', label: 'å„€è¡¨æ¿' },
    { id: 'events', icon: 'ğŸ“…', label: 'æ´»å‹•ç®¡ç†' },
    { id: 'registrations', icon: 'ğŸ“‹', label: 'å ±åç®¡ç†' },
    { id: 'poster', icon: 'ğŸ¨', label: 'AI æ–‡å®£' },
    { id: 'certificates', icon: 'ğŸ†', label: 'è­‰æ›¸ç”¢ç”Ÿ' },
    { id: 'settings', icon: 'âš™ï¸', label: 'ç³»çµ±è¨­å®š' }
  ];
  return (
    <div className="sidebar">
      <div className="logo">ğŸ“ å·¥ä½œåŠç®¡ç†</div>
      {items.map(item => (
        <div key={item.id} className={`nav-item ${page === item.id ? 'active' : ''}`} onClick={() => setPage(item.id)}>
          <span>{item.icon}</span><span>{item.label}</span>
        </div>
      ))}
    </div>
  );
}

// å„€è¡¨æ¿
function Dashboard({ events, registrations, status }) {
  const active = events.filter(e => e.status === 'active').length;
  const totalRegs = registrations.length;
  const certs = events.reduce((s, e) => s + (e.certificates || 0), 0);
  
  return (
    <div>
      <div className="header">
        <h1>ğŸ“Š å„€è¡¨æ¿</h1>
        <div style={{ display: 'flex', gap: '10px' }}>
          <span className="status-badge status-firebase">ğŸ”¥ Firebase {status.firebase ? 'å·²é€£ç·š' : 'é›¢ç·š'}</span>
          <span className="status-badge status-openai">ğŸ¤– OpenAI {status.openai ? 'å·²é€£ç·š' : 'æœªè¨­å®š'}</span>
        </div>
      </div>
      <div className="stats">
        <div className="stat-card"><div className="icon">ğŸ“…</div><div className="value">{events.length}</div><div className="label">æ´»å‹•ç¸½æ•¸</div></div>
        <div className="stat-card"><div className="icon">âœ…</div><div className="value">{active}</div><div className="label">é€²è¡Œä¸­</div></div>
        <div className="stat-card"><div className="icon">ğŸ‘¥</div><div className="value">{totalRegs}</div><div className="label">å ±åäººæ•¸</div></div>
        <div className="stat-card"><div className="icon">ğŸ†</div><div className="value">{certs}</div><div className="label">å·²ç™¼è­‰æ›¸</div></div>
      </div>
      <div className="card">
        <h3>ğŸ“‹ æœ€æ–°å ±å</h3>
        {registrations.length === 0 ? (
          <div className="empty-state"><p>ç›®å‰æ²’æœ‰å ±åè³‡æ–™</p></div>
        ) : (
          <table>
            <thead><tr><th>å§“å</th><th>æ´»å‹•</th><th>ç‹€æ…‹</th></tr></thead>
            <tbody>
              {registrations.slice(0, 5).map(r => {
                const ev = events.find(e => e.id === r.eventId);
                return (
                  <tr key={r.id}>
                    <td>{r.name}</td>
                    <td>{ev?.title || 'æœªçŸ¥æ´»å‹•'}</td>
                    <td><span className={`badge ${r.status === 'confirmed' ? 'badge-green' : 'badge-yellow'}`}>{r.status === 'confirmed' ? 'å·²ç¢ºèª' : 'å¾…ç¢ºèª'}</span></td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        )}
      </div>
    </div>
  );
}

// æ´»å‹•ç®¡ç†
function EventsPage({ events, onRefresh, showToast }) {
  const [showModal, setShowModal] = useState(false);
  const [editing, setEditing] = useState(null);
  const [form, setForm] = useState({ title: '', description: '', date: '', time: '', endTime: '', location: '', maxParticipants: 30, status: 'draft' });

  const openNew = () => {
    setEditing(null);
    setForm({ title: '', description: '', date: '', time: '', endTime: '', location: '', maxParticipants: 30, status: 'draft' });
    setShowModal(true);
  };

  const openEdit = (ev) => {
    setEditing(ev);
    setForm({
      title: ev.title || '',
      description: ev.description || '',
      date: ev.date || '',
      time: ev.time || '',
      endTime: ev.endTime || '',
      location: ev.location || '',
      maxParticipants: ev.maxParticipants || 30,
      status: ev.status || 'draft'
    });
    setShowModal(true);
  };

  const handleSubmit = async () => {
    if (!form.title || !form.date) { showToast('è«‹å¡«å¯«æ´»å‹•åç¨±å’Œæ—¥æœŸ', 'error'); return; }
    
    if (editing) {
      // æ›´æ–°ç¾æœ‰æ´»å‹•
      await fetch(`/api/events/${editing.id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(form)
      });
      showToast('æ´»å‹•å·²æ›´æ–°ï¼', 'success');
    } else {
      // æ–°å¢æ´»å‹•
      await API.addEvent(form);
      showToast('æ´»å‹•å·²æ–°å¢ï¼', 'success');
    }
    
    setShowModal(false);
    setEditing(null);
    setForm({ title: '', description: '', date: '', time: '', endTime: '', location: '', maxParticipants: 30, status: 'draft' });
    onRefresh();
  };

  const updateStatus = async (id, status) => {
    await API.updateEvent(id, { status });
    showToast('ç‹€æ…‹å·²æ›´æ–°', 'success');
    onRefresh();
  };

  const deleteEvent = async (ev) => {
    if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${ev.title}ã€ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) return;
    try {
      await fetch(`/api/events/${ev.id}`, { method: 'DELETE' });
      showToast('æ´»å‹•å·²åˆªé™¤', 'success');
      onRefresh();
    } catch (e) {
      showToast('åˆªé™¤å¤±æ•—', 'error');
    }
  };

  return (
    <div>
      <div className="header">
        <h1>ğŸ“… æ´»å‹•ç®¡ç†</h1>
        <button className="btn btn-primary" onClick={openNew}>ï¼‹ æ–°å¢æ´»å‹•</button>
      </div>
      <div className="card">
        {events.length === 0 ? (
          <div className="empty-state">
            <div className="icon">ğŸ“…</div>
            <p>é‚„æ²’æœ‰ä»»ä½•æ´»å‹•</p>
            <button className="btn btn-primary" style={{ marginTop: '20px' }} onClick={openNew}>å»ºç«‹ç¬¬ä¸€å€‹æ´»å‹•</button>
          </div>
        ) : (
          <table>
            <thead><tr><th>æ´»å‹•åç¨±</th><th>æ—¥æœŸæ™‚é–“</th><th>åœ°é»</th><th>å ±å</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead>
            <tbody>
              {events.map(ev => (
                <tr key={ev.id}>
                  <td><strong style={{ cursor: 'pointer', color: '#6366f1' }} onClick={() => openEdit(ev)}>{ev.title}</strong></td>
                  <td>{ev.date} {ev.time}{ev.endTime ? `-${ev.endTime}` : ''}</td>
                  <td>{ev.location}</td>
                  <td>{ev.registrations || 0}/{ev.maxParticipants}</td>
                  <td>
                    <span className={`badge ${ev.status === 'active' ? 'badge-green' : ev.status === 'draft' ? 'badge-gray' : 'badge-red'}`}>
                      {ev.status === 'active' ? 'é€²è¡Œä¸­' : ev.status === 'draft' ? 'è‰ç¨¿' : 'å·²çµæŸ'}
                    </span>
                  </td>
                  <td>
                    <button className="btn btn-secondary btn-sm" onClick={() => openEdit(ev)}>âœï¸ ç·¨è¼¯</button>
                    {ev.status === 'active' && <button className="btn btn-secondary btn-sm" style={{ marginLeft: '8px' }} onClick={() => { navigator.clipboard.writeText(`${window.location.origin}?register=${ev.id}`); showToast('å ±åé€£çµå·²è¤‡è£½ï¼', 'success'); }}>ğŸ”— é€£çµ</button>}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </div>

      {showModal && (
        <div className="modal-overlay" onClick={() => setShowModal(false)}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <h2>{editing ? 'âœï¸ ç·¨è¼¯æ´»å‹•' : 'â• æ–°å¢æ´»å‹•'}</h2>
            <div className="form-group">
              <label>æ´»å‹•åç¨± *</label>
              <input value={form.title} onChange={e => setForm({...form, title: e.target.value})} placeholder="ä¾‹ï¼šAI ç¹ªåœ–å·¥ä½œåŠ" />
            </div>
            <div className="form-group">
              <label>æ´»å‹•èªªæ˜</label>
              <textarea rows="3" value={form.description} onChange={e => setForm({...form, description: e.target.value})} placeholder="æ´»å‹•å…§å®¹æè¿°..." />
            </div>
            <div className="form-row">
              <div className="form-group">
                <label>æ—¥æœŸ *</label>
                <input type="date" value={form.date} onChange={e => setForm({...form, date: e.target.value})} />
              </div>
              <div className="form-group">
                <label>é–‹å§‹æ™‚é–“</label>
                <input type="time" value={form.time} onChange={e => setForm({...form, time: e.target.value})} />
              </div>
            </div>
            <div className="form-row">
              <div className="form-group">
                <label>çµæŸæ™‚é–“</label>
                <input type="time" value={form.endTime} onChange={e => setForm({...form, endTime: e.target.value})} />
              </div>
              <div className="form-group">
                <label>åœ°é»</label>
                <input value={form.location} onChange={e => setForm({...form, location: e.target.value})} placeholder="ä¾‹ï¼šç·šä¸Š Google Meet" />
              </div>
            </div>
            <div className="form-row">
              <div className="form-group">
                <label>äººæ•¸ä¸Šé™</label>
                <input type="number" value={form.maxParticipants} onChange={e => setForm({...form, maxParticipants: parseInt(e.target.value) || 30})} />
              </div>
              <div className="form-group">
                <label>ç‹€æ…‹</label>
                <select value={form.status} onChange={e => setForm({...form, status: e.target.value})}>
                  <option value="draft">è‰ç¨¿</option>
                  <option value="active">é€²è¡Œä¸­</option>
                  <option value="ended">å·²çµæŸ</option>
                </select>
              </div>
            </div>
            <div style={{ display: 'flex', gap: '10px', marginTop: '20px', flexWrap: 'wrap' }}>
              <button className="btn btn-primary" onClick={handleSubmit}>{editing ? 'ğŸ’¾ å„²å­˜è®Šæ›´' : 'å„²å­˜æ´»å‹•'}</button>
              <button className="btn btn-secondary" onClick={() => setShowModal(false)}>å–æ¶ˆ</button>
              {editing && <button className="btn btn-danger" style={{ marginLeft: 'auto' }} onClick={() => { setShowModal(false); deleteEvent(editing); }}>ğŸ—‘ï¸ åˆªé™¤</button>}
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// å ±åç®¡ç†
function RegistrationsPage({ events, registrations, onRefresh, showToast }) {
  const [filterEvent, setFilterEvent] = useState('all');

  const confirmReg = async (regId) => {
    try {
      await fetch(`/api/registrations/${regId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: 'confirmed' })
      });
      showToast('å·²ç¢ºèªå ±åï¼', 'success');
      onRefresh();
    } catch (e) {
      showToast('ç¢ºèªå¤±æ•—', 'error');
    }
  };

  const revokeReg = async (regId) => {
    if (!confirm('ç¢ºå®šè¦æ’¤éŠ·æ­¤å ±åï¼Ÿå°‡æ”¹å›ã€Œå¾…ç¢ºèªã€ç‹€æ…‹')) return;
    try {
      await fetch(`/api/registrations/${regId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: 'pending' })
      });
      showToast('å·²æ’¤éŠ·ç¢ºèª', 'success');
      onRefresh();
    } catch (e) {
      showToast('æ’¤éŠ·å¤±æ•—', 'error');
    }
  };

  const cancelReg = async (regId, eventId) => {
    if (!confirm('ç¢ºå®šè¦å–æ¶ˆæ­¤å ±åï¼Ÿ')) return;
    try {
      await fetch(`/api/registrations/${regId}/cancel`, { method: 'POST' });
      showToast('å·²å–æ¶ˆå ±å', 'success');
      onRefresh();
    } catch (e) {
      showToast('å–æ¶ˆå¤±æ•—', 'error');
    }
  };

  // æŒ‰æ´»å‹•åˆ†çµ„
  const groupedByEvent = {};
  registrations.forEach(r => {
    if (!groupedByEvent[r.eventId]) {
      groupedByEvent[r.eventId] = [];
    }
    groupedByEvent[r.eventId].push(r);
  });

  // ç¯©é¸
  const filteredGroups = filterEvent === 'all' 
    ? groupedByEvent 
    : { [filterEvent]: groupedByEvent[filterEvent] || [] };

  return (
    <div>
      <div className="header">
        <h1>ğŸ“‹ å ±åç®¡ç†</h1>
        <select style={{ padding: '10px 16px', background: '#1e1e2e', border: '1px solid #3a3a4a', borderRadius: '10px', color: '#e2e8f0' }}
          value={filterEvent} onChange={e => setFilterEvent(e.target.value)}>
          <option value="all">å…¨éƒ¨æ´»å‹•</option>
          {events.map(ev => <option key={ev.id} value={ev.id}>{ev.title}</option>)}
        </select>
      </div>
      
      {registrations.length === 0 ? (
        <div className="card">
          <div className="empty-state"><div className="icon">ğŸ“‹</div><p>ç›®å‰æ²’æœ‰å ±åè³‡æ–™</p></div>
        </div>
      ) : (
        Object.keys(filteredGroups).map(eventId => {
          const ev = events.find(e => e.id === eventId);
          const regs = filteredGroups[eventId] || [];
          if (regs.length === 0) return null;
          
          const confirmed = regs.filter(r => r.status === 'confirmed').length;
          const pending = regs.filter(r => r.status === 'pending').length;
          const cancelled = regs.filter(r => r.status === 'cancelled').length;
          
          return (
            <div className="card" key={eventId} style={{ marginBottom: '20px' }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px', flexWrap: 'wrap', gap: '10px' }}>
                <h3 style={{ margin: 0 }}>ğŸ“… {ev?.title || 'æœªçŸ¥æ´»å‹•'}</h3>
                <div style={{ display: 'flex', gap: '10px' }}>
                  <span className="badge badge-green">å·²ç¢ºèª {confirmed}</span>
                  <span className="badge badge-yellow">å¾…ç¢ºèª {pending}</span>
                  <span className="badge badge-gray">å·²å–æ¶ˆ {cancelled}</span>
                </div>
              </div>
              <table>
                <thead><tr><th>å§“å</th><th>Email</th><th>é›»è©±</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead>
                <tbody>
                  {regs.map(r => (
                    <tr key={r.id}>
                      <td>{r.name}</td>
                      <td>{r.email}</td>
                      <td>{r.phone || '-'}</td>
                      <td><span className={`badge ${r.status === 'confirmed' ? 'badge-green' : r.status === 'cancelled' ? 'badge-red' : 'badge-yellow'}`}>{r.status === 'confirmed' ? 'å·²ç¢ºèª' : r.status === 'cancelled' ? 'å·²å–æ¶ˆ' : 'å¾…ç¢ºèª'}</span></td>
                      <td>
                        {r.status === 'pending' && (
                          <>
                            <button className="btn btn-success btn-sm" onClick={() => confirmReg(r.id)}>âœ“ ç¢ºèª</button>
                            <button className="btn btn-danger btn-sm" style={{ marginLeft: '8px' }} onClick={() => cancelReg(r.id, r.eventId)}>âœ— å–æ¶ˆ</button>
                          </>
                        )}
                        {r.status === 'confirmed' && (
                          <>
                            <button className="btn btn-secondary btn-sm" onClick={() => revokeReg(r.id)}>â†© æ’¤éŠ·</button>
                            <button className="btn btn-danger btn-sm" style={{ marginLeft: '8px' }} onClick={() => cancelReg(r.id, r.eventId)}>âœ— å–æ¶ˆ</button>
                          </>
                        )}
                        {r.status === 'cancelled' && <span style={{ color: '#64748b' }}>-</span>}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          );
        })
      )}
    </div>
  );
}

// AI æ–‡å®£
function PosterPage({ events, showToast }) {
  const [selectedEvent, setSelectedEvent] = useState('');
  const [style, setStyle] = useState('social');
  const [outputs, setOutputs] = useState({ openai: '', gemini: '' });
  const [loading, setLoading] = useState(false);
  const [savedPosters, setSavedPosters] = useState([]);

  // è¼‰å…¥å·²ä¿å­˜çš„æ–‡å®£
  useEffect(() => {
    fetch('/api/posters').then(r => r.json()).then(data => setSavedPosters(data || [])).catch(() => {});
  }, []);

  const styles = [
    { id: 'social', label: 'ğŸ“± ç¤¾ç¾¤è²¼æ–‡' },
    { id: 'formal', label: 'ğŸ“„ æ­£å¼å…¬å‘Š' },
    { id: 'fun', label: 'ğŸ‰ æ´»æ½‘é¢¨æ ¼' },
    { id: 'email', label: 'ğŸ“§ Email é‚€è«‹' }
  ];

  const styleLabels = { social: 'ç¤¾ç¾¤è²¼æ–‡', formal: 'æ­£å¼å…¬å‘Š', fun: 'æ´»æ½‘é¢¨æ ¼', email: 'Email é‚€è«‹' };

  const generate = async () => {
    if (!selectedEvent) { showToast('è«‹é¸æ“‡æ´»å‹•', 'error'); return; }
    const ev = events.find(e => e.id === selectedEvent);
    setLoading(true);
    setOutputs({ openai: '', gemini: '' });
    
    const stylePrompts = {
      social: 'ç¤¾ç¾¤è²¼æ–‡é¢¨æ ¼ï¼Œæ´»æ½‘æœ‰è¶£ï¼ŒåŒ…å« emoji å’Œ hashtag',
      formal: 'æ­£å¼å…¬å‘Šé¢¨æ ¼ï¼Œå°ˆæ¥­ç°¡æ½”',
      fun: 'è¶…ç´šæ´»æ½‘é¢¨æ ¼ï¼Œå¤§é‡ emojiï¼Œå¹´è¼•åŒ–èªæ°£',
      email: 'Email é‚€è«‹å‡½é¢¨æ ¼ï¼Œç¦®è²Œæ­£å¼ä½†è¦ªåˆ‡'
    };

    try {
      const res = await fetch('/api/generate-poster-dual', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ event: ev, style: stylePrompts[style] })
      });
      const data = await res.json();
      setOutputs({ openai: data.openai || '', gemini: data.gemini || '' });
      showToast('æ–‡å®£å·²ç”Ÿæˆï¼', 'success');
    } catch (e) {
      showToast('ç”Ÿæˆå¤±æ•—', 'error');
    }
    setLoading(false);
  };

  const savePoster = async (provider, content) => {
    const ev = events.find(e => e.id === selectedEvent);
    try {
      const res = await fetch('/api/posters', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          eventId: selectedEvent,
          eventTitle: ev.title,
          style: styleLabels[style],
          provider,
          content,
          createdAt: new Date().toISOString()
        })
      });
      const data = await res.json();
      setSavedPosters(prev => [data, ...prev]);
      showToast(`å·²ä¿å­˜ ${provider} æ–‡å®£`, 'success');
    } catch (e) {
      showToast('ä¿å­˜å¤±æ•—', 'error');
    }
  };

  const deletePoster = async (posterId) => {
    if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ–‡å®£ï¼Ÿ')) return;
    try {
      await fetch(`/api/posters/${posterId}`, { method: 'DELETE' });
      setSavedPosters(prev => prev.filter(p => p.id !== posterId));
      showToast('å·²åˆªé™¤', 'success');
    } catch (e) {
      showToast('åˆªé™¤å¤±æ•—', 'error');
    }
  };

  const clearOutputs = () => {
    setOutputs({ openai: '', gemini: '' });
  };

  const activeEvents = events.filter(e => e.status === 'active');

  return (
    <div>
      <div className="header"><h1>ğŸ¨ AI æ–‡å®£ç”¢ç”Ÿå™¨</h1></div>
      
      {/* ç”¢ç”Ÿå€ */}
      <div className="card">
        <h3>ğŸ“… é¸æ“‡æ´»å‹•</h3>
        {activeEvents.length === 0 ? (
          <p style={{ color: '#64748b' }}>æ²’æœ‰é€²è¡Œä¸­çš„æ´»å‹•ï¼Œè«‹å…ˆæ–°å¢æ´»å‹•ä¸¦è¨­ç‚ºã€Œé€²è¡Œä¸­ã€</p>
        ) : (
          <select style={{ width: '100%', padding: '12px', background: '#0f0f1a', border: '1px solid #3a3a4a', borderRadius: '10px', color: '#e2e8f0' }}
            value={selectedEvent} onChange={e => setSelectedEvent(e.target.value)}>
            <option value="">-- è«‹é¸æ“‡ --</option>
            {activeEvents.map(ev => <option key={ev.id} value={ev.id}>{ev.title}</option>)}
          </select>
        )}
      </div>
      
      <div className="card">
        <h3>âœ¨ é¸æ“‡é¢¨æ ¼</h3>
        <div>{styles.map(s => <button key={s.id} className={`style-btn ${style === s.id ? 'active' : ''}`} onClick={() => setStyle(s.id)}>{s.label}</button>)}</div>
      </div>
      
      <div className="card">
        <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
          <button className="btn btn-primary" onClick={generate} disabled={loading || !selectedEvent}>
            {loading ? <><span className="loading"></span> ç”Ÿæˆä¸­...</> : 'ğŸš€ åŒæ™‚ç”¢ç”Ÿå…©ç‰ˆæ–‡å®£'}
          </button>
          {(outputs.openai || outputs.gemini) && (
            <button className="btn btn-secondary" onClick={clearOutputs}>ğŸ—‘ï¸ æ¸…é™¤çµæœ</button>
          )}
        </div>
      </div>

      {/* é›™æ¬„é¡¯ç¤ºçµæœ */}
      {(outputs.openai || outputs.gemini) && (
        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '20px' }}>
          {/* OpenAI çµæœ */}
          <div className="card">
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
              <h3 style={{ margin: 0 }}>ğŸ¤– OpenAI GPT-4o</h3>
              {outputs.openai && (
                <button className="btn btn-success btn-sm" onClick={() => savePoster('OpenAI', outputs.openai)}>âœ“ æŒ‘é¸ä¿å­˜</button>
              )}
            </div>
            {outputs.openai ? (
              <>
                <div className="ai-output">{outputs.openai}</div>
                <button className="btn btn-secondary btn-sm" style={{ marginTop: '10px' }} onClick={() => { navigator.clipboard.writeText(outputs.openai); showToast('å·²è¤‡è£½', 'success'); }}>ğŸ“‹ è¤‡è£½</button>
              </>
            ) : (
              <p style={{ color: '#64748b' }}>æœªè¨­å®šæˆ–ç”Ÿæˆå¤±æ•—</p>
            )}
          </div>
          
          {/* Gemini çµæœ */}
          <div className="card">
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
              <h3 style={{ margin: 0 }}>âœ¨ Gemini</h3>
              {outputs.gemini && (
                <button className="btn btn-success btn-sm" onClick={() => savePoster('Gemini', outputs.gemini)}>âœ“ æŒ‘é¸ä¿å­˜</button>
              )}
            </div>
            {outputs.gemini ? (
              <>
                <div className="ai-output">{outputs.gemini}</div>
                <button className="btn btn-secondary btn-sm" style={{ marginTop: '10px' }} onClick={() => { navigator.clipboard.writeText(outputs.gemini); showToast('å·²è¤‡è£½', 'success'); }}>ğŸ“‹ è¤‡è£½</button>
              </>
            ) : (
              <p style={{ color: '#64748b' }}>æœªè¨­å®šæˆ–ç”Ÿæˆå¤±æ•—</p>
            )}
          </div>
        </div>
      )}

      {/* å·²ä¿å­˜çš„æ–‡å®£ */}
      {savedPosters.length > 0 && (
        <div className="card" style={{ marginTop: '20px' }}>
          <h3>ğŸ“ å·²ä¿å­˜çš„æ–‡å®£ï¼ˆ{savedPosters.length}ï¼‰</h3>
          {savedPosters.map(p => {
            const ev = events.find(e => e.id === p.eventId);
            const isEnded = ev?.status === 'ended';
            return (
              <div key={p.id} style={{ background: '#0f0f1a', borderRadius: '12px', padding: '16px', marginTop: '12px' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '10px', flexWrap: 'wrap', gap: '10px' }}>
                  <div>
                    <strong style={{ color: '#a5b4fc' }}>{p.eventTitle}</strong>
                    <span style={{ marginLeft: '10px', fontSize: '12px', color: '#64748b' }}>{p.style} Â· {p.provider}</span>
                    {isEnded && <span className="badge badge-red" style={{ marginLeft: '10px' }}>å·²çµæŸ</span>}
                  </div>
                  <div style={{ display: 'flex', gap: '8px' }}>
                    <button className="btn btn-secondary btn-sm" onClick={() => { navigator.clipboard.writeText(p.content); showToast('å·²è¤‡è£½', 'success'); }}>ğŸ“‹ è¤‡è£½</button>
                    <button className="btn btn-danger btn-sm" onClick={() => deletePoster(p.id)}>ğŸ—‘ï¸ åˆªé™¤</button>
                  </div>
                </div>
                <div style={{ fontSize: '14px', color: '#94a3b8', whiteSpace: 'pre-wrap', maxHeight: '150px', overflow: 'auto' }}>{p.content}</div>
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}

// è­‰æ›¸ç”¢ç”Ÿ
function CertificatesPage({ events, registrations, showToast }) {
  const [selectedEvent, setSelectedEvent] = useState('');
  const [previewReg, setPreviewReg] = useState(null);

  const formatDate = (dateStr) => {
    if (!dateStr) return '';
    const d = new Date(dateStr);
    return d.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  };

  const generateCert = (reg, ev) => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'landscape' });
    
    // èƒŒæ™¯
    doc.setFillColor(99, 102, 241);
    doc.rect(0, 0, 297, 210, 'F');
    doc.setFillColor(255, 255, 255);
    doc.roundedRect(20, 20, 257, 170, 10, 10, 'F');
    
    // æ¨™é¡Œ
    doc.setTextColor(99, 102, 241);
    doc.setFontSize(36);
    doc.text('Certificate of Completion', 148.5, 55, { align: 'center' });
    
    // åˆ†éš”ç·š
    doc.setDrawColor(99, 102, 241);
    doc.setLineWidth(0.5);
    doc.line(80, 65, 217, 65);
    
    // This is to certify that
    doc.setTextColor(100, 100, 100);
    doc.setFontSize(14);
    doc.text('This is to certify that', 148.5, 85, { align: 'center' });
    
    // å§“å
    doc.setTextColor(50, 50, 50);
    doc.setFontSize(28);
    doc.text(reg.name, 148.5, 105, { align: 'center' });
    
    // has successfully completed
    doc.setTextColor(100, 100, 100);
    doc.setFontSize(14);
    doc.text('has successfully completed the workshop', 148.5, 122, { align: 'center' });
    
    // æ´»å‹•åç¨± (ç”¨è‹±æ–‡æˆ–ä¿æŒç°¡çŸ­)
    doc.setTextColor(99, 102, 241);
    doc.setFontSize(20);
    const titleLines = doc.splitTextToSize(ev.title, 200);
    doc.text(titleLines, 148.5, 140, { align: 'center' });
    
    // æ—¥æœŸ
    doc.setTextColor(100, 100, 100);
    doc.setFontSize(12);
    doc.text(`Date: ${formatDate(ev.date)}`, 148.5, 165, { align: 'center' });
    
    doc.save(`certificate-${reg.name}.pdf`);
    showToast(`Certificate downloaded for ${reg.name}`, 'success');
  };

  const sendCertByEmail = async (reg, ev) => {
    try {
      const res = await fetch('/api/send-certificate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ registration: reg, event: ev })
      });
      const data = await res.json();
      if (data.success) {
        showToast(`è­‰æ›¸å·²å¯„é€è‡³ ${reg.email}`, 'success');
      } else {
        showToast(data.error || 'å¯„é€å¤±æ•—', 'error');
      }
    } catch (e) {
      showToast('å¯„é€å¤±æ•—', 'error');
    }
  };

  const endedEvents = events.filter(e => e.status === 'ended');
  const eventRegs = selectedEvent ? registrations.filter(r => r.eventId === selectedEvent && r.status === 'confirmed') : [];
  const selectedEventData = events.find(e => e.id === selectedEvent);

  return (
    <div>
      <div className="header"><h1>ğŸ† è­‰æ›¸ç”¢ç”Ÿ</h1></div>
      <div className="card">
        <h3>ğŸ“… é¸æ“‡å·²çµæŸçš„æ´»å‹•</h3>
        {endedEvents.length === 0 ? (
          <p style={{ color: '#64748b' }}>æ²’æœ‰å·²çµæŸçš„æ´»å‹•ã€‚è«‹å…ˆåœ¨ã€Œæ´»å‹•ç®¡ç†ã€å°‡æ´»å‹•ç‹€æ…‹æ”¹ç‚ºã€Œå·²çµæŸã€ã€‚</p>
        ) : (
          <select style={{ width: '100%', padding: '12px', background: '#0f0f1a', border: '1px solid #3a3a4a', borderRadius: '10px', color: '#e2e8f0' }}
            value={selectedEvent} onChange={e => setSelectedEvent(e.target.value)}>
            <option value="">-- è«‹é¸æ“‡ --</option>
            {endedEvents.map(ev => <option key={ev.id} value={ev.id}>{ev.title} ({ev.date})</option>)}
          </select>
        )}
      </div>
      {selectedEvent && (
        <div className="card">
          <h3>ğŸ‘¥ å·²ç¢ºèªçš„å­¸å“¡ï¼ˆ{eventRegs.length} äººï¼‰</h3>
          {eventRegs.length === 0 ? (
            <p style={{ color: '#64748b' }}>æ­¤æ´»å‹•æ²’æœ‰å·²ç¢ºèªçš„å­¸å“¡</p>
          ) : (
            <>
              <table>
                <thead><tr><th>å§“å</th><th>Email</th><th>æ“ä½œ</th></tr></thead>
                <tbody>
                  {eventRegs.map(r => (
                    <tr key={r.id}>
                      <td>{r.name}</td>
                      <td>{r.email}</td>
                      <td>
                        <button className="btn btn-primary btn-sm" onClick={() => generateCert(r, selectedEventData)}>ğŸ“„ ä¸‹è¼‰</button>
                        <button className="btn btn-secondary btn-sm" style={{ marginLeft: '8px' }} onClick={() => sendCertByEmail(r, selectedEventData)}>ğŸ“§ å¯„é€</button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
              <div style={{ marginTop: '20px', display: 'flex', gap: '10px' }}>
                <button className="btn btn-primary" onClick={() => eventRegs.forEach(r => generateCert(r, selectedEventData))}>ğŸ“„ ä¸‹è¼‰å…¨éƒ¨è­‰æ›¸</button>
                <button className="btn btn-secondary" onClick={async () => {
                  for (const r of eventRegs) { await sendCertByEmail(r, selectedEventData); }
                }}>ğŸ“§ å¯„é€å…¨éƒ¨è­‰æ›¸</button>
              </div>
            </>
          )}
        </div>
      )}
    </div>
  );
}

// ç³»çµ±è¨­å®š
function SettingsPage({ status }) {
  return (
    <div>
      <div className="header"><h1>âš™ï¸ ç³»çµ±è¨­å®š</h1></div>
      <div className="card">
        <h3>ğŸ”Œ é€£ç·šç‹€æ…‹</h3>
        <table>
          <tbody>
            <tr><td>ğŸ”¥ Firebase</td><td><span className={`badge ${status.firebase ? 'badge-green' : 'badge-red'}`}>{status.firebase ? 'å·²é€£ç·š' : 'é›¢ç·š'}</span></td></tr>
            <tr><td>ğŸ¤– OpenAI</td><td><span className={`badge ${status.openai ? 'badge-green' : 'badge-yellow'}`}>{status.openai ? 'å·²é€£ç·š' : 'æœªè¨­å®š'}</span></td></tr>
            <tr><td>âœ¨ Gemini</td><td><span className={`badge ${status.gemini ? 'badge-green' : 'badge-yellow'}`}>{status.gemini ? 'å·²é€£ç·š' : 'æœªè¨­å®š'}</span></td></tr>
            <tr><td>ğŸ“§ Email (Resend)</td><td><span className={`badge ${status.email ? 'badge-green' : 'badge-yellow'}`}>{status.email ? 'å·²é€£ç·š' : 'æœªè¨­å®š'}</span></td></tr>
            <tr><td>ğŸ‘¥ ç®¡ç†å“¡</td><td><span className={`badge ${status.adminCount > 0 ? 'badge-green' : 'badge-yellow'}`}>{status.adminCount > 0 ? status.adminCount + ' äºº' : 'æœªè¨­å®š'}</span></td></tr>
          </tbody>
        </table>
      </div>
      <div className="card">
        <h3>ğŸ“ ç’°å¢ƒè®Šæ•¸èªªæ˜</h3>
        <p style={{ color: '#94a3b8', lineHeight: '1.8' }}>
          è«‹åœ¨ Render ç’°å¢ƒè®Šæ•¸ä¸­è¨­å®šï¼š<br/><br/>
          <strong>å¿…è¦ï¼š</strong><br/>
          â€¢ <code>LINE_CHANNEL_ACCESS_TOKEN</code> - LINE Bot Token<br/>
          â€¢ <code>LINE_CHANNEL_SECRET</code> - LINE Bot Secret<br/>
          â€¢ <code>FIREBASE_SERVICE_ACCOUNT</code> - Firebase JSON<br/><br/>
          <strong>AI åŠŸèƒ½ï¼š</strong><br/>
          â€¢ <code>OPENAI_API_KEY</code> - OpenAI API é‡‘é‘°<br/>
          â€¢ <code>GEMINI_API_KEY</code> - Gemini API é‡‘é‘°<br/><br/>
          <strong>é€šçŸ¥åŠŸèƒ½ï¼š</strong><br/>
          â€¢ <code>RESEND_API_KEY</code> - Resend API é‡‘é‘°<br/>
          â€¢ <code>SENDER_EMAIL</code> - å¯„ä»¶äºº Emailï¼ˆé è¨­ onboarding@resend.devï¼‰<br/>
          â€¢ <code>ADMIN_USER_IDS</code> - ç®¡ç†å“¡ LINE User IDï¼ˆå¤šäººç”¨é€—è™Ÿåˆ†éš”ï¼‰
        </p>
      </div>
    </div>
  );
}

// ä¸»ç¨‹å¼
function App() {
  const [page, setPage] = useState('dashboard');
  const [events, setEvents] = useState([]);
  const [registrations, setRegistrations] = useState([]);
  const [status, setStatus] = useState({ firebase: false, openai: false, gemini: false });
  const [toast, setToast] = useState(null);

  // æª¢æŸ¥æ˜¯å¦ç‚ºå…¬é–‹å ±åé é¢
  const urlParams = new URLSearchParams(window.location.search);
  const registerEventId = urlParams.get('register');

  const showToast = (message, type) => setToast({ message, type });
  
  const refresh = async () => {
    try {
      const [evs, regs, st] = await Promise.all([API.getEvents(), API.getRegistrations(), API.getStatus()]);
      setEvents(evs);
      setRegistrations(regs);
      setStatus(st);
    } catch (e) {
      console.error('Refresh error:', e);
    }
  };

  useEffect(() => { refresh(); }, []);

  // å¦‚æœæ˜¯å…¬é–‹å ±åé é¢ï¼Œé¡¯ç¤ºå ±åè¡¨å–®
  if (registerEventId) {
    return <PublicRegisterForm eventId={registerEventId} />;
  }

  return (
    <div className="app">
      <Sidebar page={page} setPage={setPage} />
      <div className="main">
        {page === 'dashboard' && <Dashboard events={events} registrations={registrations} status={status} />}
        {page === 'events' && <EventsPage events={events} onRefresh={refresh} showToast={showToast} />}
        {page === 'registrations' && <RegistrationsPage events={events} registrations={registrations} onRefresh={refresh} showToast={showToast} />}
        {page === 'poster' && <PosterPage events={events} showToast={showToast} />}
        {page === 'certificates' && <CertificatesPage events={events} registrations={registrations} showToast={showToast} />}
        {page === 'settings' && <SettingsPage status={status} />}
      </div>
      {toast && <Toast {...toast} onClose={() => setToast(null)} />}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
